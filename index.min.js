!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).forceDirectedGraph=e()}(this,(function(){"use strict";var t={csv:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=t.join(", ");return e&&(n=n.replace(/, ([^,]*)$/," and $1")),n}};function e(){return["#a50026","#f46d43","#fdae61","#a6d96a","#66bd63","#006837"].reverse()}function n(){var t=e();return d3.scaleLinear().domain(d3.range(t.length)).range(t).clamp(!0)}var i={id_var:"id",event_var:"event",event_order_var:"event_order",start_timepoint_var:"stdy",end_timepoint_var:"endy",duration_var:"duration",sequence_var:"seq",timepoint:0,timeUnit:"days since randomization",duration:null,resetDelay:15e3,events:null,eventCentral:null,eventCount:!0,eventChangeCount:null,eventChangeCountAesthetic:"color",individualCounts:null,individualCountEvents:null,excludeFirst:!0,excludeLast:!0,speed:"slow",speeds:{slow:1e3,medium:200,fast:50},playPause:"play",width:null,height:null,padding:1,nOrbits:null,orbitRadius:150,nFoci:null,translate:!1,hideControls:!1,colorBy:{type:"frequency",variable:null,label:null},colors:e,colorScale:n,color:function(t){return n()(Math.min(t,n().domain().length))},fill:null,minRadius:null,maxRadius:null,shape:"circle",modal:!0,modalSpeed:15e3,explanation:["Each bubble in this animation represents an individual.","As individuals experience events and change states, their bubble gravitates toward the focus representing that event.","The number of state changes dictates the color and/or size of the bubbles.","Use the controls above to interact with and alter the animation."],information:null};function s(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",i=e.append(n).classed("fdg-".concat(t),!0);return i}function a(){var t=this,e=s("main",d3.select(this.element)),n=s("controls",e).classed("fdg-hidden",this.settings.hideControls),i=s("sidebar",e),a=s("timing",i).style("position","relative"),r=s("timer",a),o=s("slider",a,"input").attr("type","range").attr("min",0).attr("value",0).property("disabled",!0).attr("title","The animation is ".concat(d3.format(".1%")(this.settings.timepoint/this.settings.duration)," complete with ").concat(this.settings.duration," ").concat(this.settings.timeUnit.split(" ")[0]," to go."));o.on("change",(function(){console.log(this.value),t.settings.timepoint=+this.value}));var c=s("countdown",a).style("height","22px").style("width","100%").style("text-align","center").selectAll("div").data(d3.range(-1,this.settings.resetDelay/1e3)).join("div").style("width","100%").style("display","inline-block").text((function(t){return"Looping in ".concat(t+1," second").concat(0===t?"":"s")})).classed("fdg-hidden",!0),l=s("legends",i),u=s("freq-table",i),d=s("info",i),h=s("animation",e);this.settings.width=h.node().clientWidth,this.settings.height=h.node().clientHeight;var g=s("svg--background",h,"svg").attr("width",this.settings.width).attr("height",this.settings.height),f=s("canvas",h,"canvas").attr("width",this.settings.width).attr("height",this.settings.height);return f.context=f.node().getContext("2d"),{main:e,controls:n,sidebar:i,timing:a,timer:r,slider:o,countdown:c,legends:l,freqTable:u,info:d,animation:h,svgBackground:g,canvas:f,svgForeground:s("svg--foreground",h,"svg").attr("width",this.settings.width).attr("height",this.settings.height),modal:s("modal",h)}}function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function c(t){return function(t){if(Array.isArray(t))return u(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||l(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t,e){if(t){if("string"==typeof t)return u(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(t,e):void 0}}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function d(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=l(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,r=!0,o=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return r=t.done,t},e:function(t){o=!0,a=t},f:function(){try{r||null==n.return||n.return()}finally{if(o)throw a}}}}function h(){var t=d3.nest().key((function(t){return t.id})).rollup((function(t){return d3.sum(t,(function(t){return+t.duration}))})).entries(this.data);return t.forEach((function(t){t.duration=t.value,t.value=t.key,delete t.key})),t}function g(){var t=d3.nest().key((function(t){return t.event})).rollup((function(t){var e=t[0];return{order:parseInt(e.event_order),position:e.hasOwnProperty("event_position")?parseInt(e.event_position):0,count:0,prevCount:0,cumulative:0,nEvents:t.length}})).entries(this.data);return t.forEach((function(t){Object.assign(t,t.value),t.value=t.key,delete t.key})),t.sort((function(t,e){return t.order-e.order||e.nEvents-t.nEvents})),t}function f(t){var e=this;return d3.nest().key((function(t){return t.order})).entries(t.filter((function(t){return t.value!==e.settings.eventCentral})))}function v(t){var e=this;this.settings.orbitRadius=this.settings.width/(t.orbit.length+1);var n=this.settings.orbitRadius/2,i=this.settings.height/2,s=2*Math.PI/(this.settings.nFoci||t.event.length-!!this.settings.eventCentral-1);t.event.forEach((function(t,a){t.radius=t.order*e.settings.orbitRadius,t.theta=0!==t.position?2*Math.PI*t.position/360:function(t){return 0===t?0:1===t?-1.75:2===t?.75:3===t?-.25:4===t?.25:0}(a)*s,t.x=0===t.order?n:n+t.radius*Math.cos(t.theta),t.y=0===t.order?i:i+t.radius*Math.sin(t.theta)})),t.orbit.forEach((function(t,s){t.cx=n,t.cy=i,t.r=(s+1)*e.settings.orbitRadius}))}function p(){var t=this,e={};e.id=h.call(this),this.settings.duration=this.settings.duration||d3.max(e.id,(function(t){return t.duration})),this.settings.minRadius=this.settings.minRadius||3e3/e.id.length,this.settings.maxRadius=this.settings.maxRadius||this.settings.minRadius+this.settings.colors().length,this.settings.fill=this.settings.fill||e.id.length<=2500,e.event=g.call(this),this.settings.width=this.settings.width||e.event.length,this.settings.eventCentral=this.settings.eventCentral||e.event[0].value,this.settings.eventFinal=Array.isArray(this.settings.eventFinal)&&this.settings.eventFinal.length?this.settings.eventFinal:[this.settings.eventFinal||e.event[e.event.length-1].value],this.settings.nFoci=this.settings.nFoci||e.event.length-!!this.settings.eventCentral,this.settings.eventChangeCount=this.settings.eventChangeCount||e.event.slice(1).map((function(t){return t.value})),this.settings.eventSequence=e.event.filter((function(n,i){return!!t.settings.excludeLast&&i!==e.event.length-1})).filter((function(e,n){return!!t.settings.excludeFirst&&0!==n})).map((function(t){return t.value})),this.settings.R=this.settings.width/e.event.length/2,e.orbit=f.call(this,e.event),v.call(this,e);var n=this.settings.colors();return"frequency"===this.settings.colorBy.type?this.colorScale=d3.scaleLinear().domain(d3.range(n.length)).range(n).clamp(!0):"continuous"===this.settings.colorBy.type?this.colorScale=d3.scaleSequential().domain(d3.extent(this.data,(function(e){return e[t.settings.colorBy.variable]})).reverse()).interpolator(d3.interpolateRdYlGn).clamp(!0):"categorical"===this.settings.colorBy.type&&(this.colorScale=d3.scaleOrdinal().domain(c(new Set(this.data.map((function(e){return e[t.settings.colorBy.variable]}))).values())).range(d3.schemeTableau10)),e}function m(t,e){var n=this;return void 0!==e?t[e]:t.find((function(e,i){return e.start_timepoint<=n.settings.timepoint&&n.settings.timepoint<=e.end_timepoint||i===t.length-1}))}function y(t){var e=this;return t.filter((function(t){return t.start_timepoint<=e.settings.timepoint})).filter((function(t){return e.settings.eventChangeCount.includes(t.event)})).length}function b(t){return"color"!==this.settings.eventChangeCountAesthetic?Math.min(this.settings.minRadius+t,this.settings.maxRadius):this.settings.minRadius}function x(t){var e="size"!==this.settings.eventChangeCountAesthetic?this.settings.color(t):"rgb(170,170,170)",n=e.replace("rgb","rgba").replace(")",", 0.5)"),i=e.replace("rgb","rgba").replace(")",", 1)");return{color:e,fill:n,stroke:i}}function C(){var t=this;this.metadata.event.forEach((function(t){t.prevCount=t.count})),this.data.nested.forEach((function(e){e.value.state=m.call(t,e.value.group),e.value.nStateChanges=y.call(t,e.value.group),e.value.r=b.call(t,e.value.nStateChanges),Object.assign(e.value,x.call(t,e.value.nStateChanges))})),this.metadata.event.forEach((function(e){e.data=t.data.nested.filter((function(t){return t.value.state.event===e.value})),e.count=e.data.length,e.cumulative=t.data.filter((function(n){return n.event===e.value&&n.start_timepoint<=t.settings.timepoint})).length,e.change=e.count-e.prevCount}))}function w(){var t=this;this.orbits.each((function(e){e.change=d3.sum(e.values,(function(t){return t.change})),e.change>0&&d3.select(this).transition().duration(t.settings.speeds[t.settings.speed]/2).attr("stroke-width",.5*e.change).transition().duration(t.settings.speeds[t.settings.speed]/2).attr("stroke-width",.5)}))}function k(){var t=this;this.controls.timepoint.inputs.property("value",this.settings.timepoint),this.containers.timer.text("".concat(this.settings.timepoint," ").concat(this.settings.timeUnit)),this.containers.slider.attr("value",this.settings.timepoint).attr("title","The animation is ".concat(d3.format(".1%")(this.settings.timepoint/this.settings.duration)," complete with ").concat(this.settings.duration-this.settings.timepoint," ").concat(this.settings.timeUnit.split(" ")[0]," to go.")),this.settings.eventCount&&this.focusAnnotations.selectAll("tspan.fdg-focus-annotation__event-count").text((function(e){return"".concat(e.count," (").concat(d3.format(".1%")(e.count/t.data.nested.length),")")})),this.freqTable.tr.selectAll("td").data((function(t){return[t.value,t.cumulative]})).join("td").text((function(t){return t}))}function _(){C.call(this),w.call(this),k.call(this)}function A(){var t=this,e=this.settings.resetDelay/1e3-1;return this.containers.countdown.classed("fdg-hidden",(function(t){return t!==e})),window.setInterval((function(){e--,t.containers.countdown.classed("fdg-hidden",(function(t){return t!==e}))}),1e3)}function S(t){d3.select(this).transition().duration(t/15).delay(t-t/15*2).style("opacity",0)}function R(t,e){t.style("opacity",0).transition().duration(e/15).style("opacity",1).on("end",(function(){S.call(this,e)}))}function P(){var t=this,e=0;this.containers.modal.text(this.settings.text[e]).call(R,this.settings.modalSpeed),this.modal=d3.interval((function(){++e===t.settings.text.length-1&&(e=0),t.containers.modal.text(t.settings.text[e]).call(R,t.settings.modalSpeed)}),this.settings.modalSpeed)}function j(){var t=this;this.settings.timepoint=0,this.settings.notesIndex=0,this.controls.timepoint.inputs.attr("value",0),this.metadata.event.forEach((function(t){t.prevCount=0,t.count=0,t.cumulative=0})),this.data.nested.forEach((function(e){e.value.state=m.call(t,e.value.group,0),e.value.nStateChanges=y.call(t,e.value.group),e.value.r=b.call(t,e.value.nStateChanges),Object.assign(e.value,x.call(t,e.value.nStateChanges))})),this.modal&&this.modal.stop(),P.call(this)}function O(t){var e=this,n=window.setTimeout((function(){j.call(e),e.containers.timer.text("".concat(e.settings.timepoint," ").concat(e.settings.timeUnit)),e.containers.slider.attr("value",e.settings.timepoint),window.clearInterval(t),window.clearTimeout(n),e.containers.countdown.classed("fdg-hidden",!0),e.interval=z.call(e)}),this.settings.resetDelay);return n}function E(){this.interval.stop();var t=A.call(this);O.call(this,t)}function M(){var t=this;this.metadata.event.forEach((function(e){1===t.settings.timepoint&&e.forceSimulation.force("center",null),e.forceSimulation.nodes(e.data),e.forceSimulation.alpha(1).restart()}))}var q=function(t){this.settings.timepoint+=!!t,this.settings.timepoint<=this.settings.duration?_.call(this):E.call(this),M.call(this)};function z(){return d3.interval(q.bind(this),this.settings.speeds[this.settings.speed])}var T=[{action:"play",label:"Play",html:"&#9658;"},{action:"pause",label:"Pause",html:"&#10074;&#10074;"}];function I(){var t=this;this.settings.playPause=T.find((function(e){return e.action!==t.settings.playPause})).action,this.controls.playPause.inputs.attr("title","".concat(T.find((function(e){return e.action!==t.settings.playPause})).label," animation")).html(T.find((function(e){return e.action!==t.settings.playPause})).html),"play"===this.settings.playPause?this.interval=z.call(this):this.interval.stop()}function D(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--speed",!0),i=n.selectAll("div").data(Object.keys(this.settings.speeds).map((function(e){return{label:e,value:t.settings.speeds[e]}}))).enter().append("div").attr("class",(function(e){return"fdg-button ".concat(e.label," ").concat(e.label===t.settings.speed?"current":"")})).attr("title",(function(e){return"Advance the animation every ".concat(t.settings.speeds[e.label]/1e3," second(s).")})).text((function(t){return t.label}));return i.on("click",(function(t){e.settings.speed=t.label,i.classed("current",(function(e){return e.label===t.label})),"play"===e.settings.playPause&&(e.interval.stop(),e.interval=z.call(e))})),{container:n,inputs:i}}function F(){var t=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--play-pause",!0),n=e.append("div").classed("fdg-button fdg-input",!0).attr("title","".concat(T.find((function(e){return e.action!==t.settings.playPause})).label," animation.")).html(T.find((function(e){return e.action!==t.settings.playPause})).html);return n.on("click",(function(){I.call(t)})),{container:e,inputs:n}}function B(){var t=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--step",!0),n=e.append("div").classed("fdg-button fdg-input",!0).attr("title","Advance animation by one time unit.").text("Step");return n.on("click",(function(){"pause"!==t.settings.playPause&&I.call(t),q.call(t,!0)})),{container:e,inputs:n}}function L(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--step",!0),i=n.append("input").classed("fdg-button fdg-input",!0).attr("type","number").attr("title","Choose a timepoint.").attr("value",+this.settings.timepoint).attr("min",1).attr("max",this.settings.duration);return i.on("click",(function(){"pause"!==t.settings.playPause&&I.call(t)})),i.on("change",(function(){"pause"!==e.settings.playPause&&I.call(e),e.settings.timepoint=+this.value-1,q.call(e,!0)})),{container:n,inputs:i}}function $(){var t=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--reset",!0),n=e.append("div").classed("fdg-button fdg-input",!0).attr("title","Reset animation.").html("&#x21ba;");return n.on("click",(function(){j.call(t),"play"!==t.settings.playPause&&I.call(t)})),{container:e,inputs:n}}function U(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--event-list",!0),i=n.selectAll("div").data(this.metadata.event).enter().append("div").attr("class",(function(e){return"fdg-button ".concat(t.settings.eventChangeCount.includes(e.value)?"current":"")})).attr("title",(function(e){return"".concat(t.settings.eventChangeCount.includes(e.value)?"Remove":"Add"," ").concat(e.value," ").concat(t.settings.eventChangeCount.includes(e.value)?"from":"to"," the list of events that control bubble ").concat("both"===t.settings.eventChangeCountAesthetic?"color and size":t.settings.eventChangeCountAesthetic,".")})).text((function(t){return t.value}));return i.on("click",(function(t){var n=this;this.classList.toggle("current"),e.settings.eventChangeCount.includes(this.textContent)?e.settings.eventChangeCount.splice(e.settings.eventChangeCount.findIndex((function(t){return t===n.textContent})),1):e.settings.eventChangeCount.push(this.textContent),this.title="".concat(e.settings.eventChangeCount.includes(t.value)?"Remove":"Add"," ").concat(t.value," ").concat(e.settings.eventChangeCount.includes(t.value)?"from":"to"," the list of events that control bubble ").concat("both"===e.settings.eventChangeCountAesthetic?"color and size":e.settings.eventChangeCountAesthetic,"."),e.controls.colorSizeToggle.inputs.attr("title",(function(t){return"Quantify the number of ".concat(e.util.csv(e.settings.eventChangeCount)," events by ").concat("both"!==t?t:"color and size",".")})),e.legends.container.classed("fdg-hidden",0===e.settings.eventChangeCount.length).selectAll("span.fdg-measure").text(e.util.csv(e.settings.eventChangeCount)),q.call(e,!1)})),{container:n,inputs:i}}function N(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--color-size",!0),i=n.selectAll("div").data(["color","size","both"]).enter().append("div").attr("class",(function(e){return"fdg-button ".concat(e," ").concat(e===t.settings.eventChangeCountAesthetic?"current":"")})).attr("title",(function(n){return"Quantify the number of ".concat(e.util.csv(t.settings.eventChangeCount)," events by ").concat("both"!==n?n:"color and size")})).text((function(t){return t}));return i.on("click",(function(t){i.classed("current",(function(e){return e===t})),e.settings.eventChangeCountAesthetic=t,e.controls.eventList.inputs.attr("title",(function(t){return"".concat(e.settings.eventChangeCount.includes(t.value)?"Remove":"Add"," ").concat(t.value," ").concat(e.settings.eventChangeCount.includes(t.value)?"from":"to"," the list of events that control bubble ").concat("both"===e.settings.eventChangeCountAesthetic?"color and size":e.settings.eventChangeCountAesthetic,".")})),e.legends.container.selectAll(".fdg-legend").classed("fdg-hidden",(function(){return!Array.from(this.classList).some((function(e){return e.includes(t)}))})),q.call(e,!1)})),{container:n,inputs:i}}function Y(){this.controls={container:this.containers.controls},this.controls.speed=D.call(this),this.controls.playPause=F.call(this),this.controls.step=B.call(this),this.controls.timepoint=L.call(this),this.controls.reset=$.call(this),this.controls.eventList=U.call(this),this.controls.colorSizeToggle=N.call(this),this.controls.container.selectAll(".fdg-button").on("mousedown",(function(){this.classList.toggle("clicked")})).on("mouseup",(function(){this.classList.toggle("clicked")}))}var G={color:function(t,e){var n=this;return t.selectAll("rect.legend-mark").data(this.settings.colors()).enter().append("rect").classed("legend-mark",!0).attr("x",(function(t,i){return i*(e[0]/n.settings.colors().length)})).attr("y",0).attr("width",e[0]/this.settings.colors().length).attr("height",e[1]/2).attr("fill",(function(t){return t})).attr("fill-opacity",.5).attr("stroke",(function(t){return t})).attr("stroke-opacity",1)},size:function(t,e){var n=this;return t.selectAll("circle.legend-mark").data(this.settings.colors()).enter().append("circle").classed("legend-mark",!0).attr("cx",(function(t,i){return i*(e[0]/n.settings.colors().length)+e[0]/n.settings.colors().length/2})).attr("cy",e[1]/4).attr("r",(function(t,e){return e+n.settings.minRadius})).attr("fill","#aaa").attr("fill-opacity",.5).attr("stroke","#aaa").attr("stroke-opacity",1)},both:function(t,e){var n=this;return t.selectAll("circle.legend-mark").data(this.settings.colors()).enter().append("circle").classed("legend-mark",!0).attr("cx",(function(t,i){return i*(e[0]/n.settings.colors().length)+e[0]/n.settings.colors().length/2})).attr("cy",e[1]/4).attr("r",(function(t,e){return e+n.settings.minRadius})).attr("fill",(function(t){return t})).attr("fill-opacity",.5).attr("stroke",(function(t){return t})).attr("stroke-opacity",1)}};function Q(t){var e=[200,50],n=this.legends.container.append("div").classed("fdg-legend fdg-legend--".concat(t),!0).classed("fdg-hidden",this.settings.eventChangeCountAesthetic!==t||0===this.settings.eventChangeCount.length),i=n.append("div").classed("fdg-legend__label",!0).html('Number of <span class = "fdg-measure">'.concat(this.util.csv(this.settings.eventChangeCount),"</span> events")),s=n.append("svg").attr("width",e[0]).attr("height",e[1]).append("g"),a=G[t].call(this,s,e),r=s.append("text").attr("x",e[0]/this.settings.colors().length/2).attr("y",e[1]/2+16).attr("text-anchor","middle").text("0"),o=s.append("text").attr("x",e[0]-e[0]/this.settings.colors().length/2).attr("y",e[1]/2+16).attr("text-anchor","middle").text("".concat(this.settings.colors().length-1,"+"));return{container:n,label:i,svg:s,marks:a,lower:r,upper:o}}function X(){this.legends={container:this.containers.legends},this.legends.color=Q.call(this,"color"),this.legends.size=Q.call(this,"size"),this.legends.both=Q.call(this,"both")}function H(){var t={container:this.containers.freqTable};return t.table=t.container.append("table"),t.thead=t.table.append("thead"),t.th=t.thead.append("th").attr("colspan",2).text("Cumulative Number of Events"),t.tbody=t.table.append("tbody"),t.tr=t.tbody.selectAll("tr").data(this.metadata.event.slice(1)).join("tr"),t.td=t.tr.selectAll("td").data((function(t){return[t.value,t.cumulative]})).join("td").text((function(t){return t})),t}function W(){var t=this.containers.svgBackground.append("g").classed("fdg-g fdg-g--orbits",!0);t.append("defs").selectAll("filter").data(this.metadata.orbit).join("filter").attr("id",(function(t,e){return"orbit--".concat(e)})).append("feDropShadow").attr("dx",0).attr("dy",0).attr("stdDeviation",5).attr("flood-color","black");var e=t.selectAll("circle.orbit").data(this.metadata.orbit).enter().append("circle").classed("orbit",!0).attr("cx",(function(t){return t.cx})).attr("cy",(function(t){return t.cy})).attr("r",(function(t){return t.r})).attr("fill","none").attr("stroke","#aaa").attr("stroke-width",".5").style("filter",(function(t,e){return"url(#orbit--".concat(e,")")}));return this.settings.translate&&e.attr("transform","translate(-".concat(this.settings.width/2-100,",-").concat(this.settings.height/2-100,")")),e}function J(){var t=this,e=this.containers.svgForeground.append("g").classed("fdg-g fdg-g--focus-annotations",!0).selectAll("g.fdg-focus-annotation").data(this.metadata.event).join("g").classed("fdg-focus-annotation",!0);this.settings.translate&&e.attr("transform","translate(-".concat(this.settings.width/2-100,",-").concat(this.settings.height/2-100,")"));var n=function(e){return Math.round(e.x)===Math.round(t.settings.orbitRadius/2)},i=function(e){return 1===e.order||Math.round(e.x)<Math.round(t.settings.width/2)},s=function(t){return n(t)?t.x:t.x-10*Math.pow(-1,i(t))},a=function(t){return n(t)?"middle":i(t)?"start":"end"},r=function(e){return function(e){return Math.round(e.y)===Math.round(t.settings.height/2)}(e)?e.y:e.y+35*Math.pow(-1,function(e){return Math.round(e.y)<Math.round(t.settings.height/2)}(e))},o=e.append("text").classed("fdg-focus-annotation__text",!0).attr("x",(function(t){return s(t)})).attr("y",(function(t){return r(t)}));o.append("tspan").classed("fdg-focus-annotation__label",!0).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).style("font-weight","bold").style("font-size","20px").attr("stroke","white").attr("stroke-width","4px").text((function(t){return t.value})),o.append("tspan").classed("fdg-focus-annotation__event-count",!0).classed("fdg-hidden",!1===this.settings.eventCount).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).attr("dy","1.3em").style("font-weight","bold").attr("stroke","white").attr("stroke-width","4px");var c=e.append("text").classed("fdg-focus-annotation__text",!0).attr("x",(function(t){return s(t)})).attr("y",(function(t){return r(t)}));return c.append("tspan").classed("fdg-focus-annotation__label",!0).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).style("font-weight","bold").style("font-size","20px").attr("fill","black").text((function(t){return t.value})),c.append("tspan").classed("fdg-focus-annotation__event-count",!0).classed("fdg-hidden",!1===this.settings.eventCount).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).attr("dy","1.3em").style("font-weight","bold").attr("fill","black"),e}function K(){Y.call(this),this.containers.timer.text("".concat(this.settings.timepoint," ").concat(this.settings.timeUnit)),X.call(this),this.freqTable=H.call(this),this.orbits=W.call(this),this.focusAnnotations=J.call(this),this.containers.slider.attr("max",this.settings.duration)}function V(){var t,e={},n=d(Object.keys(this.settings).filter((function(t){return/_var$/.test(t)})));try{for(n.s();!(t=n.n()).done;){var i=t.value;e[i.replace(/_var$/,"")]=this.data[0].hasOwnProperty(this.settings[i])}}catch(t){n.e(t)}finally{n.f()}return e}function Z(){var t=this;this.data.forEach((function(e){var n,i=d(Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})));try{for(i.s();!(n=i.n()).done;){var s=n.value,a=s.replace(/_var$/,"");e[a]=["event_order","start_timepoint","end_timepoint","duration","sequence"].includes(a)?+e[t.settings[s]]:e[t.settings[s]]}}catch(t){i.e(t)}finally{i.f()}}))}function tt(t){d3.nest().key((function(t){return t.id})).rollup((function(e){e.forEach((function(n,i){t.duration&&!t.start_timepoint&&(0===i?(n.start_timepoint=1,n.end_timepoint=n.duration):(n.start_timepoint=e[i-1].end_timepoint+1,n.end_timepoint=n.start_timepoint+n.duration-1)),t.start_timepoint&&!t.end_timepoint&&(n.end_timepoint=i<e.length-1?e[i+1].start_timepoint-1:n.duration?n.start_timepoint+n.duration-1:n.start_timepoint),!t.duration&&t.start_timepoint&&t.end_timepoint&&(n.duration=n.start_timepoint-n.end_timepoint+1)})),t.sequence?e.sort((function(t,e){return t.seq-e.seq})):e.sort((function(t,e){return t.start_timepoint-e.start_timepoint})).forEach((function(t,e){t.seq=e}))})).entries(this.data)}function et(){var t=this.data.every((function(t){return/^-?\d+\.?\d*$/.test(t.id)||/^-?\d*\.?\d+$/.test(t.id)}));this.data.sort((function(e,n){var i=t?+e.id-+n.id:e.id<n.id?-1:n.id<e.id?1:0,s=e.seq-n.seq;return i||s}))}function nt(){var t=V.call(this);Z.call(this),tt.call(this,t),et.call(this)}function it(){var t=this;return d3.nest().key((function(t){return t.id})).rollup((function(e){d3.sum(e,(function(t){return t.duration}));var n=m.call(t,e,0),i=1===e.length&&n.event===t.settings.eventCentral,s=y.call(t,e),a=b.call(t,s),c=x.call(t,s);return function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({group:e,duration:d3.sum(e,(function(t){return t.duration})),state:n,noStateChange:i,nStateChanges:s,r:a},c)})).entries(this.data)}function st(){var t=this;nt.call(this),this.data.nested=it.call(this),this.metadata.event.forEach((function(e){e.data=t.data.nested.filter((function(t){return t.value.state.event===e.value}))}))}function at(t){var e=this;this.containers.canvas.context.clearRect(0,0,this.settings.width,this.settings.height),this.containers.canvas.context.save(),this.data.nested.sort((function(t,e){return t.value.stateChanges-e.value.stateChanges})).forEach((function(t,n){e.containers.canvas.context.beginPath(),"circle"===e.settings.shape?(e.containers.canvas.context.moveTo(t.x+t.r,t.y),e.containers.canvas.context.arc(t.x,t.y,t.value.r,0,2*Math.PI),e.settings.fill&&(e.containers.canvas.context.fillStyle=t.value.fill,e.containers.canvas.context.fill()),e.containers.canvas.context.strokeStyle=t.value.stroke,e.containers.canvas.context.stroke()):(e.containers.canvas.context.rect(t.x-t.value.r,t.y-t.value.r,2*t.value.r,2*t.value.r),e.settings.fill&&(e.containers.canvas.context.fillStyle=t.value.fill,e.containers.canvas.context.fill()),e.containers.canvas.context.strokeStyle=t.value.stroke,e.containers.canvas.context.stroke())})),this.containers.canvas.context.restore()}function rt(t){var e=d3.forceSimulation().nodes(t.data).alphaDecay(.01).velocityDecay(.9).force("center",d3.forceCenter(this.settings.orbitRadius/2,this.settings.height/2)).force("x",d3.forceX(t.x).strength(.3)).force("y",d3.forceY(t.y).strength(.3)).force("charge",d3.forceManyBodyReuse().strength(-2e3/this.metadata.id.length)).on("tick",at.bind(this,t));return e.force("collide",d3.forceCollide().radius(this.settings.minRadius+.5)),e}function ot(t){for(var e=d3.forceSimulation().nodes(t).force("center",d3.forceCenter(this.settings.orbitRadius/2,this.settings.height/2)).force("x",d3.forceX(this.settings.orbitRadius/2).strength(.3)).force("y",d3.forceY(this.settings.height/2).strength(.3)).force("charge",d3.forceManyBodyReuse().strength(-2e3/t.length)).force("collide",d3.forceCollide().radius(this.settings.minRadius+.5)).stop(),n=0;n<300;n++)e.tick();var i=this.containers.svgBackground.insert("g",":first-child");i.append("text").attr("x",0).attr("y",-this.settings.orbitRadius/2).attr("dy",-36).attr("text-anchor","middle").text("No state changes"),i.append("text").attr("x",0).attr("y",-this.settings.orbitRadius/2).attr("dy",-16).attr("text-anchor","middle").text("".concat(t.length," (").concat(d3.format(".1%")(t.length/this.data.nested.length),")"));i.selectAll("circle").data(t).enter().append("circle").attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y})).attr("r",this.settings.minRadius).attr("fill",this.settings.color(0))}function ct(){var t=this.data.nested.filter((function(t){return t.value.noStateChange})).map((function(t){return{key:t.key}}));t.length&&ot.call(this,t)}function lt(){var t=this;P.call(this),ct.call(this),this.metadata.event.forEach((function(e){e.forceSimulation=rt.call(t,e)})),"play"===this.settings.playPause&&(this.interval=z.call(this))}return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={data:e,element:n,settings:Object.assign(i,s),util:t};return r.settings.text=[].concat(r.settings.explanation).concat(r.settings.information).filter((function(t){return"string"==typeof t})),r.containers=a.call(r),r.metadata=p.call(r),K.call(r),st.call(r),lt.call(r),r}}));
