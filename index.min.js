!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).forceDirectedGraph=n()}(this,(function(){"use strict";var t={csv:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],e=t.join(", ");return n&&(e=e.replace(/, ([^,]*)$/," and $1")),e}};function n(){return["#a50026","#f46d43","#fdae61","#a6d96a","#66bd63","#006837"].reverse()}function e(){var t=n();return d3.scaleLinear().domain(d3.range(t.length)).range(t).clamp(!0)}var i={id_var:"id",event_var:"event",event_order_var:"event_order",start_timepoint_var:"stdy",end_timepoint_var:"endy",duration_var:"duration",sequence_var:"seq",timepoint:0,timeUnit:"days since randomization",duration:null,resetDelay:15e3,events:null,eventCentral:null,eventCount:!0,eventChangeCount:null,eventChangeCountAesthetic:"color",individualCounts:null,individualCountEvents:null,excludeFirst:!0,excludeLast:!0,speed:"slow",speeds:{slow:1e3,medium:200,fast:50},playPause:"play",width:null,height:null,padding:1,nOrbits:null,orbitRadius:150,nFoci:null,translate:!1,hideControls:!1,colors:n,colorScale:e,color:function(t){return e()(Math.min(t,e().domain().length))},fill:null,minRadius:null,maxRadius:null,notes:null};function s(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",i=n.append(e).classed("fdg-".concat(t),!0);return i}function a(){var t=this,n=s("main",d3.select(this.element)),e=s("controls",n).classed("fdg-hidden",this.settings.hideControls),i=s("sidebar",n),a=s("timing",i).style("position","relative"),r=s("timer",a),o=s("slider",a,"input").attr("type","range").attr("min",0).attr("value",0).property("disabled",!0).attr("title","The animation is ".concat(d3.format(".1%")(this.settings.timepoint/this.settings.duration)," complete with ").concat(this.settings.duration," ").concat(this.settings.timeUnit.split(" ")[0]," to go."));o.on("change",(function(){console.log(this.value),t.settings.timepoint=+this.value}));var c=s("countdown",a).style("height","22px").style("width","100%").style("text-align","center").selectAll("div").data(d3.range(-1,this.settings.resetDelay/1e3)).join("div").style("width","100%").style("display","inline-block").text((function(t){return"Looping in ".concat(t+1," second").concat(0===t?"":"s")})).classed("fdg-hidden",!0),l=s("legends",i),u=s("freq-table",i),d=s("info",i),h=s("animation",n);this.settings.width=h.node().clientWidth,this.settings.height=h.node().clientHeight;var g=s("svg--background",h,"svg").attr("width",this.settings.width).attr("height",this.settings.height),f=s("canvas",h,"canvas").attr("width",this.settings.width).attr("height",this.settings.height);return f.context=f.node().getContext("2d"),{main:n,controls:e,sidebar:i,timing:a,timer:r,slider:o,countdown:c,legends:l,freqTable:u,info:d,animation:h,svgBackground:g,canvas:f,svgForeground:s("svg--foreground",h,"svg").attr("width",this.settings.width).attr("height",this.settings.height)}}function r(){var t=d3.nest().key((function(t){return t.id})).rollup((function(t){return d3.sum(t,(function(t){return+t.duration}))})).entries(this.data);return t.forEach((function(t){t.duration=t.value,t.value=t.key,delete t.key})),t}function o(){var t=d3.nest().key((function(t){return t.event})).rollup((function(t){var n=t[0];return{order:parseInt(n.event_order),count:0,prevCount:0,cumulative:0,nEvents:t.length}})).entries(this.data);return t.forEach((function(t){Object.assign(t,t.value),t.value=t.key,delete t.key})),t.sort((function(t,n){return t.order-n.order||n.nEvents-t.nEvents})),t}function c(t){var n=this;return d3.nest().key((function(t){return t.order})).entries(t.filter((function(t){return t.value!==n.settings.eventCentral})))}function l(t){var n=this;this.settings.orbitRadius=this.settings.width/(t.orbit.length+1);var e=this.settings.orbitRadius/2,i=this.settings.height/2,s=2*Math.PI/(this.settings.nFoci||t.event.length-!!this.settings.eventCentral-1),a=function(t){return 0===t?0:1===t?-1.75:2===t?.75:3===t?-.25:4===t?.25:0};t.event.forEach((function(t,r){t.x=0===t.order?e:t.order*n.settings.orbitRadius*Math.cos(a(r)*s)+e,t.y=0===t.order?i:t.order*n.settings.orbitRadius*Math.sin(a(r)*s)+i})),t.orbit.forEach((function(t,s){t.cx=e,t.cy=i,t.r=(s+1)*n.settings.orbitRadius}))}function u(){var t=this,n={};return n.id=r.call(this),this.settings.duration=this.settings.duration||d3.max(n.id,(function(t){return t.duration})),this.settings.minRadius=this.settings.minRadius||3e3/n.id.length,this.settings.maxRadius=this.settings.maxRadius||this.settings.minRadius+this.settings.colors().length,this.settings.fill=this.settings.fill||n.id.length<=2500,n.event=o.call(this),this.settings.width=this.settings.width||n.event.length,this.settings.eventCentral=this.settings.eventCentral||n.event[0].value,this.settings.eventFinal=Array.isArray(this.settings.eventFinal)&&this.settings.eventFinal.length?this.settings.eventFinal:[this.settings.eventFinal||n.event[n.event.length-1].value],this.settings.nFoci=this.settings.nFoci||n.event.length-!!this.settings.eventCentral,this.settings.eventChangeCount=this.settings.eventChangeCount||n.event.slice(1).map((function(t){return t.value})),this.settings.eventSequence=n.event.filter((function(e,i){return!!t.settings.excludeLast&&i!==n.event.length-1})).filter((function(n,e){return!!t.settings.excludeFirst&&0!==e})).map((function(t){return t.value})),this.settings.R=this.settings.width/n.event.length/2,n.orbit=c.call(this,n.event),l.call(this,n),n}function d(t,n){var e=this;return n?t[n]:t.find((function(n,i){return n.start_timepoint<=e.settings.timepoint&&e.settings.timepoint<=n.end_timepoint||i===t.length-1}))}function h(t){var n=this;return t.filter((function(t){return t.start_timepoint<=n.settings.timepoint})).filter((function(t){return n.settings.eventChangeCount.includes(t.event)})).length}function g(t){return"color"!==this.settings.eventChangeCountAesthetic?Math.min(this.settings.minRadius+t,this.settings.maxRadius):this.settings.minRadius}function f(t){var n="size"!==this.settings.eventChangeCountAesthetic?this.settings.color(t):"rgb(170,170,170)",e=n.replace("rgb","rgba").replace(")",", 0.5)"),i=n.replace("rgb","rgba").replace(")",", 1)");return{color:n,fill:e,stroke:i}}function v(){var t=this;this.metadata.event.forEach((function(t){t.prevCount=t.count})),this.data.nested.forEach((function(n){n.value.state=d.call(t,n.value.group),n.value.nStateChanges=h.call(t,n.value.group),n.value.r=g.call(t,n.value.nStateChanges),Object.assign(n.value,f.call(t,n.value.nStateChanges))})),this.metadata.event.forEach((function(n){n.data=t.data.nested.filter((function(t){return t.value.state.event===n.value})),n.count=n.data.length,n.cumulative=t.data.filter((function(e){return e.event===n.value&&e.start_timepoint<=t.settings.timepoint})).length,n.change=n.count-n.prevCount}))}function p(){var t=this;this.orbits.each((function(n){n.change=d3.sum(n.values,(function(t){return t.change})),n.change>0&&d3.select(this).transition().duration(t.settings.speeds[t.settings.speed]/2).attr("stroke-width",.5*n.change).transition().duration(t.settings.speeds[t.settings.speed]/2).attr("stroke-width",.5)}))}function m(){var t=this;this.containers.timer.text("".concat(this.settings.timepoint," ").concat(this.settings.timeUnit)),this.settings.eventCount&&this.focusAnnotations.selectAll("tspan.fdg-focus-annotation__event-count").text((function(n){return"".concat(n.count," (").concat(d3.format(".1%")(n.count/t.data.nested.length),")")})),Array.isArray(this.settings.notes)&&(this.settings.timepoint===this.settings.notes[this.settings.notesIndex].startTimepoint?this.containers.info.style("opacity",0).transition().duration(600).style("opacity",1).text(this.settings.notes[this.settings.notesIndex].text):this.settings.timepoint===this.settings.notes[this.settings.notesIndex].stopTimepoint&&(this.containers.info.transition().duration(1e3).style("opacity",0),this.settings.notesIndex+=1,this.settings.notesIndex===this.settings.notes.length&&(this.settings.notesIndex=0)))}function y(t){var n=Math.sqrt(~~(Math.random()*this.settings.R*this.settings.R)),e=2*Math.random()*Math.PI;return{sx:t.x+n*Math.cos(e),sy:t.y+n*Math.sin(e),tx:t.x,ty:t.y}}function b(){var t=this;this.settings.timepoint=0,this.controls.timepoint.inputs.attr("value",0),this.metadata.event.forEach((function(t){t.count=0,t.cumulative=0})),this.data.nested.forEach((function(n){n.value.state=d.call(t,n.value.group,0),n.value.events.forEach((function(t){t.count=0,t.duration=0})),n.value.moves=0,n.value.nextStateChange=n.value.state.duration;var e=t.metadata.event.find((function(t){return t.value===n.value.state.event})),i=d3.sum(n.value.events.filter((function(n){return t.settings.eventChangeCount.includes(n.value)})),(function(t){return t.count}));Object.assign(n.value,y.call(t,e)),n.value.r=g.call(t,i),Object.assign(n.value,f.call(t,i))}))}var x=function(t){var n=this;this.settings.timepoint+=!!t;var e=Math.min(this.settings.timepoint,this.settings.duration);if(this.containers.slider.attr("value",e).attr("title","The animation is ".concat(d3.format(".1%")(e/this.settings.duration)," complete with ").concat(this.settings.duration-e," ").concat(this.settings.timeUnit.split(" ")[0]," to go.")),this.controls.timepoint.inputs.attr("value",e),this.settings.timepoint<=this.settings.duration)v.call(this),p.call(this),m.call(this);else{this.interval.stop();var i=this.settings.resetDelay/1e3-1;this.containers.countdown.classed("fdg-hidden",(function(t){return t!==i}));var s=window.setInterval((function(){i--,n.containers.countdown.classed("fdg-hidden",(function(t){return t!==i}))}),1e3),a=window.setTimeout((function(){b.call(n),n.containers.timer.text("".concat(n.settings.timepoint," ").concat(n.settings.timeUnit)),n.containers.slider.attr("value",n.settings.timepoint),window.clearInterval(s),window.clearTimeout(a),n.containers.countdown.classed("fdg-hidden",!0),n.interval=C.call(n)}),this.settings.resetDelay)}this.freqTable.tr.selectAll("td").data((function(t){return[t.value,t.cumulative]})).join("td").text((function(t){return t})),this.metadata.event.forEach((function(t){1===n.settings.timepoint&&t.forceSimulation.force("center",null),t.tick=0,t.forceSimulation.nodes(t.data),t.forceSimulation.alpha(1).restart()}))};function C(){return d3.interval(x.bind(this),this.settings.speeds[this.settings.speed])}var w=[{action:"play",label:"Play",html:"&#9658;"},{action:"pause",label:"Pause",html:"&#10074;&#10074;"}];function k(){var t=this;this.settings.playPause=w.find((function(n){return n.action!==t.settings.playPause})).action,this.controls.playPause.inputs.attr("title","".concat(w.find((function(n){return n.action!==t.settings.playPause})).label," animation")).html(w.find((function(n){return n.action!==t.settings.playPause})).html),"play"===this.settings.playPause?this.interval=C.call(this):this.interval.stop()}function _(){var t=this,n=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--speed",!0),i=e.selectAll("div").data(Object.keys(this.settings.speeds).map((function(n){return{label:n,value:t.settings.speeds[n]}}))).enter().append("div").attr("class",(function(n){return"fdg-button ".concat(n.label," ").concat(n.label===t.settings.speed?"current":"")})).attr("title",(function(n){return"Advance the animation every ".concat(t.settings.speeds[n.label]/1e3," second(s).")})).text((function(t){return t.label}));return i.on("click",(function(t){n.settings.speed=t.label,i.classed("current",(function(n){return n.label===t.label})),"play"===n.settings.playPause&&(n.interval.stop(),n.interval=C.call(n))})),{container:e,inputs:i}}function A(){var t=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--play-pause",!0),e=n.append("div").classed("fdg-button fdg-input",!0).attr("title","".concat(w.find((function(n){return n.action!==t.settings.playPause})).label," animation.")).html(w.find((function(n){return n.action!==t.settings.playPause})).html);return e.on("click",(function(){k.call(t)})),{container:n,inputs:e}}function R(){var t=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--step",!0),e=n.append("div").classed("fdg-button fdg-input",!0).attr("title","Advance animation by one time unit.").text("Step");return e.on("click",(function(){"pause"!==t.settings.playPause&&k.call(t),x.call(t,!0)})),{container:n,inputs:e}}function P(){var t=this,n=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--step",!0),i=e.append("input").classed("fdg-button fdg-input",!0).attr("title","Choose a timepoint.").attr("value",this.settings.timepoint).attr("min",1).attr("max",this.settings.duration);return i.on("click",(function(){"pause"!==t.settings.playPause&&k.call(t)})),i.on("change",(function(){"pause"!==n.settings.playPause&&k.call(n),n.settings.timepoint=this.value-1,x.call(n,!0)})),{container:e,inputs:i}}function j(){var t=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--reset",!0),e=n.append("div").classed("fdg-button fdg-input",!0).attr("title","Reset animation.").html("&#x21ba;");return e.on("click",(function(){b.call(t),"play"!==t.settings.playPause&&k.call(t)})),{container:n,inputs:e}}function O(){var t=this,n=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--event-list",!0),i=e.selectAll("div").data(this.metadata.event).enter().append("div").attr("class",(function(n){return"fdg-button ".concat(t.settings.eventChangeCount.includes(n.value)?"current":"")})).attr("title",(function(n){return"".concat(t.settings.eventChangeCount.includes(n.value)?"Remove":"Add"," ").concat(n.value," ").concat(t.settings.eventChangeCount.includes(n.value)?"from":"to"," the list of events that control bubble ").concat("both"===t.settings.eventChangeCountAesthetic?"color and size":t.settings.eventChangeCountAesthetic,".")})).text((function(t){return t.value}));return i.on("click",(function(t){var e=this;this.classList.toggle("current"),n.settings.eventChangeCount.includes(this.textContent)?n.settings.eventChangeCount.splice(n.settings.eventChangeCount.findIndex((function(t){return t===e.textContent})),1):n.settings.eventChangeCount.push(this.textContent),this.title="".concat(n.settings.eventChangeCount.includes(t.value)?"Remove":"Add"," ").concat(t.value," ").concat(n.settings.eventChangeCount.includes(t.value)?"from":"to"," the list of events that control bubble ").concat("both"===n.settings.eventChangeCountAesthetic?"color and size":n.settings.eventChangeCountAesthetic,"."),n.controls.colorSizeToggle.inputs.attr("title",(function(t){return"Quantify the number of ".concat(n.util.csv(n.settings.eventChangeCount)," events by ").concat("both"!==t?t:"color and size",".")})),n.legends.container.classed("fdg-hidden",0===n.settings.eventChangeCount.length).selectAll("span.fdg-measure").text(n.util.csv(n.settings.eventChangeCount)),x.call(n,!1)})),{container:e,inputs:i}}function S(){var t=this,n=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--color-size",!0),i=e.selectAll("div").data(["color","size","both"]).enter().append("div").attr("class",(function(n){return"fdg-button ".concat(n," ").concat(n===t.settings.eventChangeCountAesthetic?"current":"")})).attr("title",(function(e){return"Quantify the number of ".concat(n.util.csv(t.settings.eventChangeCount)," events by ").concat("both"!==e?e:"color and size")})).text((function(t){return t}));return i.on("click",(function(t){i.classed("current",(function(n){return n===t})),n.settings.eventChangeCountAesthetic=t,n.controls.eventList.inputs.attr("title",(function(t){return"".concat(n.settings.eventChangeCount.includes(t.value)?"Remove":"Add"," ").concat(t.value," ").concat(n.settings.eventChangeCount.includes(t.value)?"from":"to"," the list of events that control bubble ").concat("both"===n.settings.eventChangeCountAesthetic?"color and size":n.settings.eventChangeCountAesthetic,".")})),n.legends.container.selectAll(".fdg-legend").classed("fdg-hidden",(function(){return!Array.from(this.classList).some((function(n){return n.includes(t)}))})),x.call(n,!1)})),{container:e,inputs:i}}function M(){this.controls={container:this.containers.controls},this.controls.speed=_.call(this),this.controls.playPause=A.call(this),this.controls.step=R.call(this),this.controls.timepoint=P.call(this),this.controls.reset=j.call(this),this.controls.eventList=O.call(this),this.controls.colorSizeToggle=S.call(this),this.controls.container.selectAll(".fdg-button").on("mousedown",(function(){this.classList.toggle("clicked")})).on("mouseup",(function(){this.classList.toggle("clicked")}))}var E={color:function(t,n){var e=this;return t.selectAll("rect.legend-mark").data(this.settings.colors()).enter().append("rect").classed("legend-mark",!0).attr("x",(function(t,i){return i*(n[0]/e.settings.colors().length)})).attr("y",0).attr("width",n[0]/this.settings.colors().length).attr("height",n[1]/2).attr("fill",(function(t){return t})).attr("fill-opacity",.5).attr("stroke",(function(t){return t})).attr("stroke-opacity",1)},size:function(t,n){var e=this;return t.selectAll("circle.legend-mark").data(this.settings.colors()).enter().append("circle").classed("legend-mark",!0).attr("cx",(function(t,i){return i*(n[0]/e.settings.colors().length)+n[0]/e.settings.colors().length/2})).attr("cy",n[1]/4).attr("r",(function(t,n){return n+e.settings.minRadius})).attr("fill","#aaa").attr("fill-opacity",.5).attr("stroke","#aaa").attr("stroke-opacity",1)},both:function(t,n){var e=this;return t.selectAll("circle.legend-mark").data(this.settings.colors()).enter().append("circle").classed("legend-mark",!0).attr("cx",(function(t,i){return i*(n[0]/e.settings.colors().length)+n[0]/e.settings.colors().length/2})).attr("cy",n[1]/4).attr("r",(function(t,n){return n+e.settings.minRadius})).attr("fill",(function(t){return t})).attr("fill-opacity",.5).attr("stroke",(function(t){return t})).attr("stroke-opacity",1)}};function I(t){var n=[200,50],e=this.legends.container.append("div").classed("fdg-legend fdg-legend--".concat(t),!0).classed("fdg-hidden",this.settings.eventChangeCountAesthetic!==t||0===this.settings.eventChangeCount.length),i=e.append("div").classed("fdg-legend__label",!0).html('Number of <span class = "fdg-measure">'.concat(this.util.csv(this.settings.eventChangeCount),"</span> events")),s=e.append("svg").attr("width",n[0]).attr("height",n[1]).append("g"),a=E[t].call(this,s,n),r=s.append("text").attr("x",n[0]/this.settings.colors().length/2).attr("y",n[1]/2+16).attr("text-anchor","middle").text("0"),o=s.append("text").attr("x",n[0]-n[0]/this.settings.colors().length/2).attr("y",n[1]/2+16).attr("text-anchor","middle").text("".concat(this.settings.colors().length-1,"+"));return{container:e,label:i,svg:s,marks:a,lower:r,upper:o}}function T(){this.legends={container:this.containers.legends},this.legends.color=I.call(this,"color"),this.legends.size=I.call(this,"size"),this.legends.both=I.call(this,"both")}function q(){var t={container:this.containers.freqTable};return t.table=t.container.append("table"),t.thead=t.table.append("thead"),t.th=t.thead.append("th").attr("colspan",2).text("Cumulative Number of Events"),t.tbody=t.table.append("tbody"),t.tr=t.tbody.selectAll("tr").data(this.metadata.event.slice(1)).join("tr"),t.td=t.tr.selectAll("td").data((function(t){return[t.value,t.cumulative]})).join("td").text((function(t){return t})),t}function z(){var t=this.containers.svgBackground.append("g").classed("fdg-g fdg-g--orbits",!0);t.append("defs").selectAll("filter").data(this.metadata.orbit).join("filter").attr("id",(function(t,n){return"orbit--".concat(n)})).append("feDropShadow").attr("dx",0).attr("dy",0).attr("stdDeviation",5).attr("flood-color","black");var n=t.selectAll("circle.orbit").data(this.metadata.orbit).enter().append("circle").classed("orbit",!0).attr("cx",(function(t){return t.cx})).attr("cy",(function(t){return t.cy})).attr("r",(function(t){return t.r})).attr("fill","none").attr("stroke","#aaa").attr("stroke-width",".5").style("filter",(function(t,n){return"url(#orbit--".concat(n,")")}));return this.settings.translate&&n.attr("transform","translate(-".concat(this.settings.width/2-100,",-").concat(this.settings.height/2-100,")")),n}function D(){var t=this,n=this.containers.svgForeground.append("g").classed("fdg-g fdg-g--focus-annotations",!0).selectAll("g.fdg-focus-annotation").data(this.metadata.event).join("g").classed("fdg-focus-annotation",!0);this.settings.translate&&n.attr("transform","translate(-".concat(this.settings.width/2-100,",-").concat(this.settings.height/2-100,")"));var e=function(n){return Math.round(n.x)===Math.round(t.settings.orbitRadius/2)},i=function(n){return 1===n.order||Math.round(n.x)<Math.round(t.settings.width/2)},s=function(t){return e(t)?t.x:t.x-10*Math.pow(-1,i(t))},a=function(t){return e(t)?"middle":i(t)?"start":"end"},r=function(n){return function(n){return Math.round(n.y)===Math.round(t.settings.height/2)}(n)?n.y:n.y+35*Math.pow(-1,function(n){return Math.round(n.y)<Math.round(t.settings.height/2)}(n))},o=n.append("text").classed("fdg-focus-annotation__text",!0).attr("x",(function(t){return s(t)})).attr("y",(function(t){return r(t)}));o.append("tspan").classed("fdg-focus-annotation__label",!0).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).style("font-weight","bold").style("font-size","20px").attr("stroke","white").attr("stroke-width","4px").text((function(t){return t.value})),o.append("tspan").classed("fdg-focus-annotation__event-count",!0).classed("fdg-hidden",!1===this.settings.eventCount).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).attr("dy","1.3em").style("font-weight","bold").attr("stroke","white").attr("stroke-width","4px");var c=n.append("text").classed("fdg-focus-annotation__text",!0).attr("x",(function(t){return s(t)})).attr("y",(function(t){return r(t)}));return c.append("tspan").classed("fdg-focus-annotation__label",!0).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).style("font-weight","bold").style("font-size","20px").attr("fill","black").text((function(t){return t.value})),c.append("tspan").classed("fdg-focus-annotation__event-count",!0).classed("fdg-hidden",!1===this.settings.eventCount).attr("x",(function(t){return s(t)})).attr("text-anchor",(function(t){return a(t)})).attr("dy","1.3em").style("font-weight","bold").attr("fill","black"),n}function F(){M.call(this),this.containers.timer.text("".concat(this.settings.timepoint," ").concat(this.settings.timeUnit)),T.call(this),this.freqTable=q.call(this),this.orbits=z.call(this),this.focusAnnotations=D.call(this),this.containers.slider.attr("max",this.settings.duration)}function L(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function $(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,i)}return e}function U(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,i=new Array(n);e<n;e++)i[e]=t[e];return i}function B(t,n){var e;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(e=function(t,n){if(t){if("string"==typeof t)return U(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?U(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){e&&(t=e);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,r=!0,o=!1;return{s:function(){e=t[Symbol.iterator]()},n:function(){var t=e.next();return r=t.done,t},e:function(t){o=!0,a=t},f:function(){try{r||null==e.return||e.return()}finally{if(o)throw a}}}}function N(){var t,n={},e=B(Object.keys(this.settings).filter((function(t){return/_var$/.test(t)})));try{for(e.s();!(t=e.n()).done;){var i=t.value;n[i.replace(/_var$/,"")]=this.data[0].hasOwnProperty(this.settings[i])}}catch(t){e.e(t)}finally{e.f()}return n}function Q(){var t=this;this.data.forEach((function(n){var e,i=B(Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})));try{for(i.s();!(e=i.n()).done;){var s=e.value,a=s.replace(/_var$/,"");n[a]=["event_order","start_timepoint","end_timepoint","duration","sequence"].includes(a)?+n[t.settings[s]]:n[t.settings[s]]}}catch(t){i.e(t)}finally{i.f()}}))}function X(t){d3.nest().key((function(t){return t.id})).rollup((function(n){n.forEach((function(e,i){t.duration&&!t.start_timepoint&&(0===i?(e.start_timepoint=1,e.end_timepoint=e.duration):(e.start_timepoint=n[i-1].end_timepoint+1,e.end_timepoint=e.start_timepoint+e.duration-1)),t.start_timepoint&&!t.end_timepoint&&(e.end_timepoint=i<n.length-1?n[i+1].start_timepoint-1:e.duration?e.start_timepoint+e.duration-1:e.start_timepoint),!t.duration&&t.start_timepoint&&t.end_timepoint&&(e.duration=e.start_timepoint-e.end_timepoint+1)})),t.sequence?n.sort((function(t,n){return t.seq-n.seq})):n.sort((function(t,n){return t.start_timepoint-n.start_timepoint})).forEach((function(t,n){t.seq=n}))})).entries(this.data)}function Y(){var t=this.data.every((function(t){return/^-?\d+\.?\d*$/.test(t.id)||/^-?\d*\.?\d+$/.test(t.id)}));this.data.sort((function(n,e){var i=t?+n.id-+e.id:n.id<e.id?-1:e.id<n.id?1:0,s=n.seq-e.seq;return i||s}))}function G(){var t=N.call(this);Q.call(this),X.call(this,t),Y.call(this)}function H(){var t=this;return d3.nest().key((function(t){return t.id})).rollup((function(n){var e=1===n.length&&i.event===t.settings.eventCentral,i=(d3.sum(n,(function(t){return t.duration})),d.call(t,n,0)),s=h.call(t,n),a=g.call(t,s),r=f.call(t,s);return function(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?$(Object(e),!0).forEach((function(n){L(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):$(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}({group:n,noStateChange:e,duration:d3.sum(n,(function(t){return t.duration})),state:i,nStateChanges:s,r:a},r)})).entries(this.data)}function W(){var t=this;G.call(this),this.data.nested=H.call(this),this.metadata.event.forEach((function(n){n.data=t.data.nested.filter((function(t){return t.value.state.event===n.value}))}))}function J(t){var n=this;this.containers.canvas.context.clearRect(0,0,this.settings.width,this.settings.height),this.containers.canvas.context.save(),this.settings.translate&&this.containers.canvas.context.translate(-(this.settings.width/2-100),-(this.settings.height/2-100)),this.data.nested.sort((function(t,n){return t.value.stateChanges-n.value.stateChanges})).forEach((function(t,e){n.containers.canvas.context.beginPath(),n.containers.canvas.context.moveTo(t.x+t.r,t.y),n.containers.canvas.context.arc(t.x,t.y,t.value.r,0,2*Math.PI),n.settings.fill&&(n.containers.canvas.context.fillStyle=t.value.fill,n.containers.canvas.context.fill()),n.containers.canvas.context.strokeStyle=t.value.stroke,n.containers.canvas.context.stroke()})),this.containers.canvas.context.restore()}function K(t){var n=d3.forceSimulation().nodes(t.data).alphaDecay(.01).velocityDecay(.9).force("center",d3.forceCenter(this.settings.orbitRadius/2,this.settings.height/2)).force("x",d3.forceX(t.x).strength(.3)).force("y",d3.forceY(t.y).strength(.3)).force("charge",d3.forceManyBodyReuse().strength(-2e3/this.metadata.id.length)).on("tick",J.bind(this,t));return n.force("collide",d3.forceCollide().radius(this.settings.minRadius+.5)),n}function V(t){for(var n=d3.forceSimulation().nodes(t).force("center",d3.forceCenter(this.settings.orbitRadius/2,this.settings.height/2)).force("x",d3.forceX(this.settings.orbitRadius/2).strength(.3)).force("y",d3.forceY(this.settings.height/2).strength(.3)).force("charge",d3.forceManyBodyReuse().strength(-2e3/t.length)).force("collide",d3.forceCollide().radius(this.settings.minRadius+.5)).stop(),e=0;e<300;e++)n.tick();var i=this.containers.svgBackground.insert("g",":first-child");i.append("text").attr("x",0).attr("y",-this.settings.orbitRadius/2).attr("dy",-36).attr("text-anchor","middle").text("No state changes"),i.append("text").attr("x",0).attr("y",-this.settings.orbitRadius/2).attr("dy",-16).attr("text-anchor","middle").text("".concat(t.length," (").concat(d3.format(".1%")(t.length/this.data.nested.length),")"));i.selectAll("circle").data(t).enter().append("circle").attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y})).attr("r",this.settings.minRadius).attr("fill",this.settings.color(0))}function Z(){var t=this.data.nested.filter((function(t){return t.value.noStateChange})).map((function(t){return{key:t.key}}));t.length&&V.call(this,t)}function tt(){var t=this;this.metadata.event.forEach((function(n){n.tick=0,n.forceSimulation=K.call(t,n)})),Z.call(this),"play"===this.settings.playPause&&(this.interval=C.call(this))}return function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={data:n,element:e,settings:Object.assign(i,s),util:t};return Array.isArray(r.settings.notes)&&(r.settings.notesIndex=s.notes.some((function(t){return t.startTimepoint<=r.settings.timepoint&&r.settings.timepoint<=t.endTimepoint}))?r.settings.notes.findIndex((function(t){return t.startTimepoint<=s.timepoint&&r.settings.timepoint<=t.stopTimepoint})):0),r.containers=a.call(r),r.metadata=u.call(r),F.call(r),W.call(r),tt.call(r),r}}));
