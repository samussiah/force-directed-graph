!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).forceDirectedGraph=e()}(this,(function(){"use strict";var t={arcTween:function(t,e){return function(n){var i=d3.interpolate(n.endAngle,t);return function(t){return n.endAngle=i(t),e(n)}}},csv:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=t.join(", ");return e&&(n=n.replace(/, ([^,]*)$/," and $1")),n}};function e(){return["#a50026","#f46d43","#fdae61","#a6d96a","#66bd63","#006837"].reverse()}function n(){var t=e();return d3.scaleLinear().domain(d3.range(t.length)).range(t).clamp(!0)}var i={update:function(){var t=this;this.settings.text=[].concat(this.settings.explanation.filter((function(e){return!(t.settings.hideControls&&e.includes("controls"))}))).concat(this.settings.information).filter((function(t){return"string"==typeof t}))},id_var:"id",event_var:"event",event_order_var:"event_order",start_timepoint_var:"stdy",end_timepoint_var:"endy",duration_var:"duration",sequence_var:"seq",timepoint:0,timeUnit:"days since randomization",duration:null,resetDelay:15e3,events:null,eventCentral:null,eventCount:!0,eventChangeCount:null,eventChangeCountAesthetic:"color",drawStaticSeparately:!0,speed:"medium",speeds:{slow:1e3,medium:500,fast:100},playPause:"play",width:null,height:null,padding:1,nOrbits:null,orbitRadius:150,chargeStrength:null,nFoci:null,translate:!1,hideControls:!1,colorBy:{type:"frequency",variable:null,label:null},colors:e,colorScale:n,color:function(t){return n()(Math.min(t,n().domain().length))},fill:null,sizeBy:{type:"frequency",variable:null,label:null},minRadius:null,maxRadius:null,shape:"circle",modal:!0,modalSpeed:15e3,modalIndex:0,explanation:["Each bubble in this animation represents an individual.",'As <span class = "fdg-emphasized">time progresses</span> and individuals experience events, their bubble gravitates toward the focus or "planet" representing that event.','The <span class = "fdg-emphasized">number of events</span> an individual has experienced determines the color and/or size of their bubble.',"Static bubbles represent individuals who never experience an event.","Use the controls on the right to interact with and alter the animation.","Curious where everyone ends up?  Stick around to find out!"],information:null};function s(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function a(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){s(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t){return function(t){if(Array.isArray(t))return l(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||c(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t,e){if(t){if("string"==typeof t)return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(t,e):void 0}}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function u(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=c(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,o=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){o=!0,r=t},f:function(){try{a||null==n.return||n.return()}finally{if(o)throw r}}}}function h(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",i=e.append(n).classed("fdg-".concat(t),!0);return i}function d(t){var e=h("controls",t).classed("fdg-hidden",this.settings.hideControls);h("hide",e,"span");return{controls:e}}function g(t){var e=h("stopwatch",t).style("width","100%");return e.width=e.node().clientWidth,e.innerRadius=e.width/8,e.svg=h("stopwatch__svg",e,"svg").attr("width",e.width).attr("height",e.width),e.arc=d3.arc().innerRadius(e.innerRadius).outerRadius(e.width/2-1).cornerRadius(12).startAngle(0),e.g=h("stopwatch__path",e.svg,"g").attr("transform","translate(".concat(e.width/2,",").concat(e.width/2,")")),e.background=h("stopwatch__path",e.g,"path").datum({endAngle:2*Math.PI}).attr("d",e.arc).style("fill","white").style("stroke","black").style("stroke-width",.5),e.foreground=h("stopwatch__path",e.g,"path").datum({endAngle:0}).attr("d",e.arc).style("fill","#a6d96a").style("stroke","black").style("stroke-width",.5),e.percentBackground=h("stopwatch__text",e.g,"text").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-weight","bold").style("stroke","white").style("stroke-width","4px").text("0%"),e.percentForeground=h("stopwatch__text",e.g,"text").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-weight","bold").text("0%"),e}function f(t){var e=this.settings.resetDelay/1e3;return h("countdown",t).classed("fdg-sidebar__label",!0).selectAll("div").data(d3.range(-1,e)).join("div").text((function(t){return"Looping in ".concat(t+1," second").concat(0===t?"":"s")})).classed("fdg-hidden",(function(t){return t!==e-1})).classed("fdg-invisible",(function(t){return t===e-1}))}function p(t){var e=h("sidebar",t),n=h("legends",e),i=h("progress",e),s=h("timer",i).classed("fdg-sidebar__label",!0);return{sidebar:e,legends:n,stopwatch:g.call(this,i),progress:i,timer:s,countdown:f.call(this,i),freqTable:h("freq-table",e)}}function v(t){var e=h("animation",t);this.settings.width=e.node().clientWidth,this.settings.height=e.node().clientHeight;var n=h("svg--background",e,"svg").attr("width",this.settings.width).attr("height",this.settings.height),i=h("canvas",e,"canvas").attr("width",this.settings.width).attr("height",this.settings.height);i.context=i.node().getContext("2d");var s=h("svg--foreground",e,"svg").attr("width",this.settings.width).attr("height",this.settings.height),r=h("modal",e);return{animation:e,svgBackground:n,canvas:i,svgForeground:s,modal:h("modal__text",r)}}function y(t){var e=this;this.settings.orbitRadius=this.settings.width/(t.orbit.length+1);var n=this.settings.orbitRadius/2,i=this.settings.height/2;Math.PI,this.settings.nFoci||(t.event.length,this.settings.eventCentral);t.event.forEach((function(t,s){t.radius=t.order*e.settings.orbitRadius,t.theta=2*Math.PI*t.position/360,t.x=0===t.order?n:n+t.radius*Math.cos(t.theta),t.y=0===t.order?i:i+t.radius*Math.sin(t.theta)})),t.orbit.forEach((function(t,s){t.cx=n,t.cy=i,t.r=(s+1)*e.settings.orbitRadius}))}function m(){var t=this,e=this.containers.animation.node();if(this.settings.width=e.clientWidth,this.settings.height=this.containers.animation.node().clientHeight,this.containers.stopwatch.width=this.containers.stopwatch.node().clientWidth,this.containers.stopwatch.innerRadius=this.containers.stopwatch.width/8,this.containers.stopwatch.svg.attr("width",this.containers.stopwatch.width).attr("height",this.containers.stopwatch.width),this.containers.stopwatch.arc.innerRadius(this.containers.stopwatch.innerRadius).outerRadius(this.containers.stopwatch.width/2-1),this.containers.stopwatch.g.attr("transform","translate(".concat(this.containers.stopwatch.width/2,",").concat(this.containers.stopwatch.width/2,")")),this.containers.stopwatch.background.attr("d",this.containers.stopwatch.arc),this.containers.stopwatch.foreground.attr("d",this.containers.stopwatch.arc),this.containers.svgBackground.attr("width",this.settings.width).attr("height",this.settings.height),this.containers.canvas.attr("width",this.settings.width).attr("height",this.settings.height),this.containers.svgForeground.attr("width",this.settings.width).attr("height",this.settings.height),y.call(this,this.metadata),this.orbits.attr("cx",(function(t){return t.cx})).attr("cy",(function(t){return t.cy})).attr("r",(function(t){return t.r})),"categorical"===this.settings.colorBy.type){var n=this.metadata.event[0];n.foci.forEach((function(e,i){var s=t.staticForceSimulation[i];e.x=n.x+50*Math.cos(i*t.settings.colorBy.theta),e.y=n.y+50*Math.sin(i*t.settings.colorBy.theta),s.simulation.force("center",d3.forceCenter(e.x,e.y)).force("x",d3.forceX(e.x).strength(.3)).force("y",d3.forceY(e.y).strength(.3));for(var r=0;r<30;r++)s.simulation.tick();s.nodes.attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y}))}))}else{var i=this.staticForceSimulation[0];i.simulation.force("center",d3.forceCenter(this.settings.orbitRadius/2,this.settings.height/2)).force("x",d3.forceX(this.settings.orbitRadius/2).strength(.3)).force("y",d3.forceY(this.settings.height/2).strength(.3));for(var s=0;s<30;s++)i.simulation.tick();i.nodes.attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y}))}this.metadata.event.forEach((function(e){"categorical"===t.settings.colorBy.type?e.foci.forEach((function(n,i){n.x=e.x+50*Math.cos(i*t.settings.colorBy.theta),n.y=e.y+50*Math.sin(i*t.settings.colorBy.theta);var s=e.forceSimulation.find((function(t){return t.category===n.key}));s.force("x",d3.forceX(n.x).strength(.3)),s.force("y",d3.forceY(n.y).strength(.3))})):e.forceSimulation.forEach((function(t){t.force("x",d3.forceX(e.x).strength(.3)).force("y",d3.forceY(e.y).strength(.3))}))})),this.focusAnnotations.attr("transform",(function(t){return"translate(".concat(t.x,",").concat(t.y,")")}))}function x(){var t=h("main",d3.select(this.element)),e=d.call(this,t),n=p.call(this,t),i=v.call(this,t);return window.addEventListener("resize",m.bind(this)),a(a(a({main:t},e),n),i)}function b(){var t=this,e=d3.nest().key((function(t){return t.id})).rollup((function(e){return{duration:d3.sum(e,(function(t){return+t.duration})),static:1===e.length,category:"categorical"===t.settings.colorBy.type?e[0][t.settings.colorBy.variable]:null}})).entries(this.data);return e.forEach((function(t,e){Object.assign(t,t.value),t.value=t.key,t.duration=t.value,delete t.key})),e}function w(){var t=d3.nest().key((function(t){return t.event})).rollup((function(t){var e=t[0];return{order:parseInt(e.event_order),position:e.hasOwnProperty("event_position")?parseInt(e.event_position):null,count:0,prevCount:0,cumulative:0,nEvents:t.length}})).entries(this.data);return t.forEach((function(t){Object.assign(t,t.value),t.value=t.key,delete t.key})),d3.nest().key((function(t){return t.order})).rollup((function(t){var e=t.length,n=d3.range(-45,46);t.forEach((function(t,i){t.position=null===t.position?d3.quantile(n,(i+1)/(e+1)):t.position}))})).entries(t),t.sort((function(t,e){return t.order-e.order||e.nEvents-t.nEvents})),t}function _(t){var e=this;return d3.nest().key((function(t){return t.order})).entries(t.filter((function(t){return t.value!==e.settings.eventCentral})))}function C(){var t=this,e={};e.id=b.call(this),this.settings.duration=this.settings.duration||d3.max(e.id,(function(t){return t.duration})),this.settings.minRadius=this.settings.minRadius||3e3/e.id.filter((function(e){return!(t.settings.drawStaticSeparately&&e.static)})).length,this.settings.staticRadius=this.settings.staticRadius||3e3/e.id.length,this.settings.maxRadius=this.settings.maxRadius||this.settings.minRadius+this.settings.colors().length,this.settings.chargeStrength=-2e3/e.id.filter((function(e){return!(t.settings.drawStaticSeparately&&e.static)})).length,this.settings.staticChargeStrength=-2e3/e.id.length,this.settings.fill=this.settings.fill||e.id.length<=2500,e.event=w.call(this),this.settings.eventCentral=this.settings.eventCentral||e.event[0].value,this.settings.nFoci=this.settings.nFoci||e.event.length-!!this.settings.eventCentral,this.settings.eventChangeCount=this.settings.eventChangeCount||e.event.slice(1).map((function(t){return t.value})),e.orbit=_.call(this,e.event),y.call(this,e);var n,i=this.settings.colors();if("frequency"===this.settings.colorBy.type)n=d3.range(i.length),this.colorScale=d3.scaleLinear().domain(n).range(i).clamp(!0);else if("continuous"===this.settings.colorBy.type){n=d3.extent(this.data,(function(e){return e[t.settings.colorBy.variable]})),this.colorScale=d3.scaleSequential(d3.interpolateRdYlGn).domain(n);var s=this.colorScale.interpolator();this.settings.colorBy.mirror&&this.colorScale.interpolator((function(t){return s(1-t)}))}else"categorical"===this.settings.colorBy.type&&(n=o(new Set(this.data.map((function(e){return e[t.settings.colorBy.variable]}))).values()).sort(),this.colorScale=d3.scaleOrdinal().domain(n).range(d3.schemeTableau10),this.settings.colorBy.theta=2*Math.PI/n.length,e.event.forEach((function(e){e.foci=n.map((function(n,i){return{key:n,x:e.x+50*Math.cos(i*t.settings.colorBy.theta),y:e.y+50*Math.sin(i*t.settings.colorBy.theta)}}))})));return this.domain=n,e}function k(t,e){var n=this;return void 0!==e?t[e]:t.find((function(e,i){return e.start_timepoint<=n.settings.timepoint&&n.settings.timepoint<=e.end_timepoint||i===t.length-1}))}function S(t){var e=this;return t.filter((function(t){return t.start_timepoint<=e.settings.timepoint})).sort((function(t,e){return t.start_timepoint-e.start_timepoint})).filter((function(t,n,i){var s=i[n-1]?i[n-1].event:null;return!e.settings.eventChangeCount.includes(s)&&e.settings.eventChangeCount.includes(t.event)})).length}function A(t){return"color"!==this.settings.eventChangeCountAesthetic?Math.min(this.settings.minRadius+t,this.settings.maxRadius):this.settings.minRadius}function R(t){var e="frequency"!==this.settings.colorBy.type||"size"!==this.settings.eventChangeCountAesthetic?d3.rgb(this.colorScale(t)).toString():"rgb(170,170,170)",n=e.replace("rgb","rgba").replace(")",", 0.5)"),i=e.replace("rgb","rgba").replace(")",", 1)");return{color:e,fill:n,stroke:i}}function B(t,e,n){var i=S.call(this,t,n),s="frequency"===this.settings.colorBy.type?i:e[this.settings.colorBy.variable];return a({nStateChanges:i,aesthetic:s,r:A.call(this,i)},R.call(this,s))}function M(){var t=this;this.metadata.event.forEach((function(t){t.prevCount=t.count})),this.data.nested.forEach((function(e){e.value.statePrevious=e.value.state,e.value.state=k.call(t,e.value.group);var n=B.call(t,e.value.group,e.value.state,e.value.statePrevious);Object.assign(e.value,n)})),this.metadata.event.forEach((function(e){e.data=t.data.nested.filter((function(t){return t.value.state.event===e.value})),e.count=e.data.length,e.cumulative=t.data.filter((function(n){return n.event===e.value&&n.start_timepoint<=t.settings.timepoint})).length,e.change=e.count-e.prevCount}))}function P(){var t=this;this.orbits.each((function(e){e.change=d3.sum(e.values,(function(t){return t.change})),e.change>0&&d3.select(this).transition().duration(t.settings.speeds[t.settings.speed]/2).attr("stroke-width",.5*e.change).transition().duration(t.settings.speeds[t.settings.speed]/2).attr("stroke-width",.5)}))}function j(){var t=this;this.settings.progress=this.settings.timepoint/this.settings.duration,this.controls.timepoint.inputs.property("value",this.settings.timepoint),this.containers.timer.text("".concat(this.settings.timepoint," ").concat(this.settings.timeUnit)),this.containers.progress.attr("title","The animation is ".concat(d3.format(".1%")(this.settings.progress)," complete with ").concat(this.settings.duration-this.settings.timepoint," ").concat(this.settings.timeUnit.split(" ")[0]," to go.")),this.containers.stopwatch.foreground.transition().duration(this.settings.speed).attrTween("d",this.util.arcTween(this.settings.progress*Math.PI*2,this.containers.stopwatch.arc)).style("fill",d3.interpolateRdYlGn(1-this.settings.progress)),this.containers.stopwatch.percentBackground.text(this.settings.progress<.0095?d3.format(".1%")(this.settings.progress):d3.format(".0%")(this.settings.progress)),this.containers.stopwatch.percentForeground.text(this.settings.progress<.0095?d3.format(".1%")(this.settings.progress):d3.format(".0%")(this.settings.progress)),this.settings.eventCount&&this.focusAnnotations.selectAll("tspan.fdg-focus-annotation__event-count").text((function(e){return"".concat(e.count," (").concat(d3.format(".1%")(e.count/t.data.nested.length),")")})),this.freqTable.tr.selectAll("td").data((function(t){return[t.value,t.cumulative]})).join("td").text((function(t){return"number"==typeof t?d3.format(",d")(t):t}))}function E(){M.call(this),P.call(this),j.call(this)}function q(){var t=this,e=this.settings.resetDelay/1e3-1;return this.containers.countdown.classed("fdg-invisible",!1).classed("fdg-hidden",(function(t){return t!==e})),window.setInterval((function(){e--,t.containers.countdown.classed("fdg-hidden",(function(t){return t!==e}))}),1e3)}function O(t){d3.select(this).transition().duration(t/15).delay(t-t/15*2).style("opacity",0)}function N(t,e){t.style("opacity",0).transition().duration(e/15).style("opacity",1).on("end",(function(){O.call(this,e)}))}function z(t){t.style("outline","thick groove rgba(215,25,28,0)").transition().duration(this.settings.modalSpeed/15).style("outline","thick groove rgba(215,25,28,.5)").transition().duration(this.settings.modalSpeed/15).delay(this.settings.modalSpeed-this.settings.modalSpeed/15*2).style("outline","thick groove rgba(215,25,28,0)")}function T(){switch(this.modalText=this.settings.text[this.settings.modalIndex],this.settings.modalIndex===this.settings.text.length-1&&this.modal.stop(),this.containers.modal.html(this.modalText).call(N,this.settings.modalSpeed),!0){case/time progresses/i.test(this.modalText):z.call(this,this.containers.progress);break;case/determines the color/i.test(this.modalText):z.call(this,this.containers.legends);break;case/use the controls/i.test(this.modalText):z.call(this,this.containers.controls)}}function I(){var t=this;T.call(this),this.modal=d3.interval((function(){t.settings.modalIndex++,T.call(t)}),this.settings.modalSpeed)}function L(){var t=this;this.settings.timepoint=0,this.settings.modalIndex=0,this.controls.timepoint.inputs.attr("value",0),this.metadata.event.forEach((function(t){t.prevCount=0,t.count=0,t.cumulative=0})),this.data.nested.forEach((function(e){e.value.statePrevious=null,e.value.state=k.call(t,e.value.group,0);var n=B.call(t,e.value.group,e.value.state,e.value.statePrevious);Object.assign(e.value,n)})),this.modal&&this.modal.stop(),I.call(this)}function D(t){var e=this,n=window.setTimeout((function(){L.call(e),e.containers.timer.text("".concat(e.settings.timepoint," ").concat(e.settings.timeUnit)),e.settings.progress=0,e.containers.stopwatch.foreground.transition().duration(e.settings.speed).attrTween("d",e.util.arcTween(e.settings.progress*Math.PI*2,e.containers.stopwatch.arc)).style("fill",d3.interpolateRdYlGn(1-e.settings.progress)),window.clearInterval(t),window.clearTimeout(n),e.containers.countdown.classed("fdg-invisible",(function(t){return t===e.settings.resetDelay/1e3-1})).classed("fdg-hidden",(function(t){return t!==e.settings.resetDelay/1e3-1})),e.interval=$.call(e)}),this.settings.resetDelay);return n}function F(){this.interval.stop();var t=q.call(this);D.call(this,t)}function U(){var t=this;this.metadata.event.forEach((function(e){e.forceSimulation.forEach((function(n){1===t.settings.timepoint&&n.force("center",null),n.nodes(e.data.filter((function(t){return!t.value.noStateChange&&t.value.category===n.category}))),n.alpha(1).restart()}))}))}var Y=function(t){this.settings.timepoint+=!!t,this.settings.timepoint<=this.settings.duration?E.call(this):F.call(this),U.call(this)};function $(){return d3.interval(Y.bind(this),this.settings.speeds[this.settings.speed])}var X=[{action:"play",label:"Play",html:"&#9658;"},{action:"pause",label:"Pause",html:"&#10074;&#10074;"}];function G(){var t=this;this.settings.playPause=X.find((function(e){return e.action!==t.settings.playPause})).action,this.controls.playPause.inputs.attr("title","".concat(X.find((function(e){return e.action!==t.settings.playPause})).label," animation")).html(X.find((function(e){return e.action!==t.settings.playPause})).html),"play"===this.settings.playPause?this.interval=$.call(this):this.interval.stop()}function W(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--speed",!0),i=n.selectAll("div").data(Object.keys(this.settings.speeds).map((function(e){return{label:e,value:t.settings.speeds[e]}}))).enter().append("div").attr("class",(function(e){return"fdg-button ".concat(e.label," ").concat(e.label===t.settings.speed?"current":"")})).attr("title",(function(e){return"Advance the animation every ".concat(t.settings.speeds[e.label]/1e3," second(s).")})).text((function(t){return t.label}));return i.on("click",(function(t){e.settings.speed=t.label,i.classed("current",(function(e){return e.label===t.label})),"play"===e.settings.playPause&&(e.interval.stop(),e.interval=$.call(e))})),{container:n,inputs:i}}function V(){var t=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--play-pause",!0),n=e.append("div").classed("fdg-button fdg-input",!0).attr("title","".concat(X.find((function(e){return e.action!==t.settings.playPause})).label," animation.")).html(X.find((function(e){return e.action!==t.settings.playPause})).html);return n.on("click",(function(){G.call(t)})),{container:e,inputs:n}}function H(){var t=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--step",!0),n=e.append("div").classed("fdg-button fdg-input",!0).attr("title","Advance animation by one time unit.").text("Step");return n.on("click",(function(){"pause"!==t.settings.playPause&&G.call(t),Y.call(t,!0)})),{container:e,inputs:n}}function Q(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--timepoint",!0),i=n.append("div").classed("fdg-button fdg-input",!0).append("input").attr("type","number").attr("title","Choose a timepoint.").attr("value",+this.settings.timepoint).attr("min",1).attr("max",this.settings.duration);return i.on("click",(function(){"pause"!==t.settings.playPause&&G.call(t)})),i.on("change",(function(){"pause"!==e.settings.playPause&&G.call(e),e.settings.timepoint=+this.value-1,Y.call(e,!0)})),{container:n,inputs:i}}function J(){var t=this,e=this.controls.container.append("div").classed("fdg-control fdg-control--reset",!0),n=e.append("div").classed("fdg-button fdg-input",!0).attr("title","Reset animation.").html("&#x21ba;");return n.on("click",(function(){L.call(t),"play"!==t.settings.playPause&&G.call(t)})),{container:e,inputs:n}}function K(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--event-list",!0),i=n.selectAll("div").data(this.metadata.event).enter().append("div").attr("class",(function(e){return"fdg-button ".concat(t.settings.eventChangeCount.includes(e.value)?"current":"")})).attr("title",(function(e){return"".concat(t.settings.eventChangeCount.includes(e.value)?"Remove":"Add"," ").concat(e.value," ").concat(t.settings.eventChangeCount.includes(e.value)?"from":"to"," the list of events that control bubble ").concat("both"===t.settings.eventChangeCountAesthetic?"color and size":t.settings.eventChangeCountAesthetic,".")})).text((function(t){return t.value}));return i.on("click",(function(t){var n=this;this.classList.toggle("current"),e.settings.eventChangeCount.includes(this.textContent)?e.settings.eventChangeCount.splice(e.settings.eventChangeCount.findIndex((function(t){return t===n.textContent})),1):e.settings.eventChangeCount.push(this.textContent),this.title="".concat(e.settings.eventChangeCount.includes(t.value)?"Remove":"Add"," ").concat(t.value," ").concat(e.settings.eventChangeCount.includes(t.value)?"from":"to"," the list of events that control bubble ").concat("both"===e.settings.eventChangeCountAesthetic?"color and size":e.settings.eventChangeCountAesthetic,"."),e.controls.colorSizeToggle.inputs.attr("title",(function(t){return"Quantify the number of ".concat(e.util.csv(e.settings.eventChangeCount)," events by ").concat("both"!==t?t:"color and size",".")})),e.legends.container.classed("fdg-invisible",0===e.settings.eventChangeCount.length).selectAll("span.fdg-measure").text(e.util.csv(e.settings.eventChangeCount)),Y.call(e,!1)})),{container:n,inputs:i}}function Z(){var t=this,e=this,n=this.controls.container.append("div").classed("fdg-control fdg-control--color-size",!0),i=n.selectAll("div").data(["color","size","both"]).enter().append("div").attr("class",(function(e){return"fdg-button ".concat(e," ").concat(e===t.settings.eventChangeCountAesthetic?"current":"")})).attr("title",(function(n){return"Quantify the number of ".concat(e.util.csv(t.settings.eventChangeCount)," events by ").concat("both"!==n?n:"color and size")})).text((function(t){return t}));return i.on("click",(function(t){i.classed("current",(function(e){return e===t})),e.settings.eventChangeCountAesthetic=t,e.controls.eventList.inputs.attr("title",(function(t){return"".concat(e.settings.eventChangeCount.includes(t.value)?"Remove":"Add"," ").concat(t.value," ").concat(e.settings.eventChangeCount.includes(t.value)?"from":"to"," the list of events that control bubble ").concat("both"===e.settings.eventChangeCountAesthetic?"color and size":e.settings.eventChangeCountAesthetic,".")})),e.legends.container.selectAll(".fdg-legend").classed("fdg-hidden",(function(){return!Array.from(this.classList).some((function(e){return e.includes(t)}))})),Y.call(e,!1)})),{container:n,inputs:i}}function tt(){this.controls={container:this.containers.controls},this.controls.speed=W.call(this),this.controls.playPause=V.call(this),this.controls.step=H.call(this),this.controls.timepoint=Q.call(this),this.controls.reset=J.call(this),"frequency"===this.settings.colorBy.type&&(this.controls.eventList=K.call(this),this.controls.colorSizeToggle=Z.call(this)),this.controls.container.selectAll(".fdg-button").on("mousedown",(function(){this.classList.toggle("clicked")})).on("mouseup",(function(){this.classList.toggle("clicked")})).on("mouseout",(function(){this.classList.contains("clicked")&&this.classList.toggle("clicked")}))}function et(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,n=document.createElement("canvas");n.width=e,n.height=1;for(var i=n.getContext("2d"),s=0;s<e;++s)i.fillStyle=t(s/(e-1)),i.fillRect(s,0,1,1);return n}var nt={color:function(t,e){var n=this;return t.selectAll("rect.legend-mark").data(this.settings.colors()).enter().append("rect").classed("legend-mark",!0).attr("x",(function(t,i){return i*(e[0]/n.settings.colors().length)})).attr("y",0).attr("width",e[0]/this.settings.colors().length).attr("height",e[1]/3).attr("fill",(function(t){return t})).attr("fill-opacity",.5).attr("stroke",(function(t){return t})).attr("stroke-opacity",1)},size:function(t,e){var n=this;return t.selectAll("circle.legend-mark").data(this.settings.colors()).enter().append("circle").classed("legend-mark",!0).attr("cx",(function(t,i){return i*(e[0]/n.settings.colors().length)+e[0]/n.settings.colors().length/2})).attr("cy",e[1]/4).attr("r",(function(t,e){return e+n.settings.minRadius})).attr("fill","#aaa").attr("fill-opacity",.5).attr("stroke","#aaa").attr("stroke-opacity",1)},both:function(t,e){var n=this;return t.selectAll("circle.legend-mark").data(this.settings.colors()).enter().append("circle").classed("legend-mark",!0).attr("cx",(function(t,i){return i*(e[0]/n.settings.colors().length)+e[0]/n.settings.colors().length/2})).attr("cy",e[1]/4).attr("r",(function(t,e){return e+n.settings.minRadius})).attr("fill",(function(t){return t})).attr("fill-opacity",.5).attr("stroke",(function(t){return t})).attr("stroke-opacity",1)}};function it(t){var e=[200,50],n=this.legends.container.append("div").classed("fdg-legend fdg-legend--".concat(t),!0).classed("fdg-hidden",this.settings.eventChangeCountAesthetic!==t||0===this.settings.eventChangeCount.length),i=n.append("div").classed("fdg-sidebar__label fdg-legend__label",!0).html('Number of <span class = "fdg-measure">'.concat(this.util.csv(this.settings.eventChangeCount),"</span> events")),s=n.append("svg").attr("width",e[0]).attr("height",e[1]).append("g"),r=nt[t].call(this,s,e),a=s.append("text").attr("x",e[0]/this.settings.colors().length/2).attr("y",e[1]/2+16).attr("text-anchor","middle").text("0"),o=s.append("text").attr("x",e[0]-e[0]/this.settings.colors().length/2).attr("y",e[1]/2+16).attr("text-anchor","middle").text("".concat(this.settings.colors().length-1,"+"));return{container:n,label:i,svg:s,marks:r,lower:a,upper:o}}function st(){var t=this;if(this.legends={container:this.containers.legends},"continuous"===this.settings.colorBy.type)this.legends.container.append("div").classed("fdg-legend fdg-legend--continuous",!0).node().appendChild(function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.color,i=e.title,s=e.tickSize,r=void 0===s?6:s,a=e.width,o=void 0===a?320:a,c=e.height,l=void 0===c?44+r:c,u=e.marginTop,h=void 0===u?18:u,d=e.marginRight,g=void 0===d?0:d,f=e.marginBottom,p=void 0===f?16+r:f,v=e.marginLeft,y=void 0===v?0:v,m=e.ticks,x=void 0===m?o/64:m,b=e.tickFormat,w=e.tickValues,_=d3.create("svg").attr("width",o).attr("height",l).attr("viewBox",[0,0,o,l]).style("overflow","visible"),C=function(t){return t.selectAll(".tick line").attr("y1",h+p-l)};if(n.interpolate){var k=Math.min(n.domain().length,n.range().length);t=n.copy().rangeRound(d3.quantize(d3.interpolate(y,o-g),k)),_.append("image").attr("x",y).attr("y",h).attr("width",o-y-g).attr("height",l-h-p).attr("preserveAspectRatio","none").attr("xlink:href",et.call(this,n.copy().domain(d3.quantize(d3.interpolate(0,1),k))).toDataURL())}else if(n.interpolator){if(t=Object.assign(n.copy().interpolator(d3.interpolateRound(y,o-g)),{range:function(){return[y,o-g]}}),_.append("image").attr("x",y).attr("y",h).attr("width",o-y-g).attr("height",l-h-p).attr("preserveAspectRatio","none").attr("xlink:href",et.call(this,n.interpolator()).toDataURL()),!t.ticks){if(void 0===w){var S=Math.round(x+1);w=d3.range(S).map((function(t){return d3.quantile(n.domain(),t/(S-1))}))}"function"!=typeof b&&(b=d3.format(void 0===b?",f":b))}}else if(n.invertExtent){var A=n.thresholds?n.thresholds():n.quantiles?n.quantiles():n.domain(),R=void 0===b?function(t){return t}:"string"==typeof b?d3.format(b):b;t=d3.scaleLinear().domain([-1,n.range().length-1]).rangeRound([y,o-g]),_.append("g").selectAll("rect").data(n.range()).join("rect").attr("x",(function(e,n){return t(n-1)})).attr("y",h).attr("width",(function(e,n){return t(n)-t(n-1)})).attr("height",l-h-p).attr("fill",(function(t){return t})),w=d3.range(A.length),b=function(t){return R(A[t],t)}}else t=d3.scaleBand().domain(n.domain()).rangeRound([y,o-g]),_.append("g").selectAll("rect").data(n.domain()).join("rect").attr("x",t).attr("y",h).attr("width",Math.max(0,t.bandwidth()-1)).attr("height",l-h-p).attr("fill",n),C=function(){};return _.append("g").attr("transform","translate(0,".concat(l-p,")")).call(d3.axisBottom(t).ticks(x,"string"==typeof b?b:void 0).tickFormat("function"==typeof b?b:void 0).tickSize(r).tickValues(w)).call(C).call((function(t){return t.select(".domain").remove()})).call((function(t){return t.append("text").classed("fdg-sidebar__label fdg-legend__label",!0).attr("x",y).attr("y",h+p-l-6).attr("fill","currentColor").attr("text-anchor","middle").attr("transform","translate(".concat(o/2,",0)")).attr("font-weight","bold").attr("font-size","1.25rem").text(i)})),_.node()}({color:this.colorScale,title:this.settings.colorBy.label,width:200,height:50,tickValues:[this.colorScale.domain()[0],(this.colorScale.domain()[1]-this.colorScale.domain()[0])/2,this.colorScale.domain()[1]]}));else if("categorical"===this.settings.colorBy.type){var e=this.legends.container.append("div").classed("fdg-legend fdg-legend--categorical",!0);e.append("div").classed("fdg-sidebar__label fdg-legend__label",!0).text(this.settings.colorBy.label);var n=e.append("svg").attr("width",200).attr("height",20*this.colorScale.domain().length).selectAll("g").data(this.colorScale.domain()).join("g");n.append("circle").attr("cx",20).attr("cy",(function(t,e){return 20*e+10})).attr("r",7).attr("fill",(function(e){return t.colorScale(e)})),n.append("text").attr("font-size","1rem").attr("x",35).attr("y",(function(t,e){return 20*e+12})).attr("alignment-baseline","middle").text((function(e){return"".concat(e," (n=").concat(t.metadata.id.filter((function(t){return t.category===e})).length,")")}))}else"frequency"===this.settings.colorBy.type&&(this.legends.color=it.call(this,"color"),this.legends.size=it.call(this,"size"),this.legends.both=it.call(this,"both"))}function rt(){var t={container:this.containers.freqTable};return t.table=t.container.append("table"),t.thead=t.table.append("thead"),t.th=t.thead.append("th").classed("fdg-sidebar__label",!0).attr("colspan",2).text("Cumulative Number of Events"),t.tbody=t.table.append("tbody"),t.tr=t.tbody.selectAll("tr").data(this.metadata.event.slice(1)).join("tr"),t.td=t.tr.selectAll("td").data((function(t){return[t.value,t.cumulative]})).join("td").text((function(t){return"number"==typeof t?d3.format(",d")(t):t})),t}function at(){var t=this.containers.svgBackground.append("g").classed("fdg-g fdg-g--orbits",!0);return t.append("defs").selectAll("filter").data(this.metadata.orbit).join("filter").attr("id",(function(t,e){return"orbit--".concat(e)})).append("feDropShadow").attr("dx",0).attr("dy",0).attr("stdDeviation",5).attr("flood-color","black"),t.selectAll("circle.orbit").data(this.metadata.orbit).enter().append("circle").classed("orbit",!0).attr("cx",(function(t){return t.cx})).attr("cy",(function(t){return t.cy})).attr("r",(function(t){return t.r})).attr("fill","none").attr("stroke","#aaa").attr("stroke-width",".5").style("filter",(function(t,e){return"url(#orbit--".concat(e,")")}))}function ot(){var t=this,e=this.containers.svgForeground.append("g").classed("fdg-g fdg-g--focus-annotations",!0).selectAll("g.fdg-focus-annotation").data(this.metadata.event).join("g").classed("fdg-focus-annotation",!0).attr("transform",(function(t){return"translate(".concat(t.x,",").concat(t.y,")")})),n=function(e){return Math.round(e.x)===Math.round(t.settings.orbitRadius/2)},i=function(e){return 1===e.order||Math.round(e.x)<Math.round(t.settings.width/2)},s=function(t){return n(t)?"middle":i(t)?"start":"end"},r=function(e){return Math.round(e.y)===Math.round(t.settings.height/2)},a=function(e){return Math.round(e.y)<Math.round(t.settings.height/2)};return["background","foreground"].forEach((function(o){var c=e.append("text").classed("fdg-focus-annotation__text fdg-focus-annotation__".concat(o),!0);c.style("transform",(function(t){return"translate(".concat(function(t){return n(t)?0:i(t)?"2em":"-2em"}(t),",").concat(function(t){return r(t)?0:a(t)?"-2em":"2em"}(t),")")}));var l=c.append("tspan").classed("fdg-focus-annotation__label",!0).attr("x",0).attr("text-anchor",(function(t){return s(t)})).text((function(t){return t.value})),u=c.append("tspan").classed("fdg-focus-annotation__event-count",!0).classed("fdg-hidden",!1===t.settings.eventCount).attr("x",0).attr("dy","1.3em").attr("text-anchor",(function(t){return s(t)}));"categorical"===t.settings.colorBy.type&&(c.style("transform",(function(t){return"translate(0,".concat(r(t)?"0":a(t)?"5em":"-5em",")")})),l.attr("text-anchor","middle"),u.attr("text-anchor","middle"))})),e}function ct(){tt.call(this),st.call(this),this.containers.timer.text("".concat(this.settings.timepoint," ").concat(this.settings.timeUnit)),this.freqTable=rt.call(this),this.orbits=at.call(this),this.focusAnnotations=ot.call(this)}function lt(){var t,e={},n=u(Object.keys(this.settings).filter((function(t){return/_var$/.test(t)})));try{for(n.s();!(t=n.n()).done;){var i=t.value;e[i.replace(/_var$/,"")]=this.data[0].hasOwnProperty(this.settings[i])}}catch(t){n.e(t)}finally{n.f()}return e}function ut(){var t=this;this.data.forEach((function(e){var n,i=u(Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})));try{for(i.s();!(n=i.n()).done;){var s=n.value,r=s.replace(/_var$/,"");e[r]=["event_order","start_timepoint","end_timepoint","duration","sequence"].includes(r)?+e[t.settings[s]]:e[t.settings[s]]}}catch(t){i.e(t)}finally{i.f()}}))}function ht(t){d3.nest().key((function(t){return t.id})).rollup((function(e){e.forEach((function(n,i){t.duration&&!t.start_timepoint&&(0===i?(n.start_timepoint=1,n.end_timepoint=n.duration):(n.start_timepoint=e[i-1].end_timepoint+1,n.end_timepoint=n.start_timepoint+n.duration-1)),t.start_timepoint&&!t.end_timepoint&&(n.end_timepoint=i<e.length-1?e[i+1].start_timepoint-1:n.duration?n.start_timepoint+n.duration-1:n.start_timepoint),!t.duration&&t.start_timepoint&&t.end_timepoint&&(n.duration=n.start_timepoint-n.end_timepoint+1)})),t.sequence?e.sort((function(t,e){return t.seq-e.seq})):e.sort((function(t,e){return t.start_timepoint-e.start_timepoint})).forEach((function(t,e){t.seq=e}))})).entries(this.data)}function dt(){var t=this.data.every((function(t){return/^-?\d+\.?\d*$/.test(t.id)||/^-?\d*\.?\d+$/.test(t.id)}));this.data.sort((function(e,n){var i=t?+e.id-+n.id:e.id<n.id?-1:n.id<e.id?1:0,s=e.seq-n.seq;return i||s}))}function gt(){var t=lt.call(this);ut.call(this),ht.call(this,t),dt.call(this)}function ft(){var t=this;return d3.nest().key((function(t){return t.id})).rollup((function(e){var n=d3.sum(e,(function(t){return t.duration})),i="categorical"===t.settings.colorBy.type?e[0][t.settings.colorBy.variable]:null,s=k.call(t,e,0);return a({group:e,duration:n,category:i,statePrevious:null,state:s,noStateChange:1===e.length&&s.event===t.settings.eventCentral},B.call(t,e,s,null))})).entries(this.data)}function pt(){var t=this;gt.call(this),this.data.nested=ft.call(this),this.metadata.event.forEach((function(e){e.data=t.data.nested.filter((function(t){return t.value.state.event===e.value}))}))}function vt(t){return function(){return t}}function yt(t,e,n,i){if(isNaN(e)||isNaN(n))return t;var s,r,a,o,c,l,u,h,d,g=t._root,f={data:i},p=t._x0,v=t._y0,y=t._x1,m=t._y1;if(!g)return t._root=f,t;for(;g.length;)if((l=e>=(r=(p+y)/2))?p=r:y=r,(u=n>=(a=(v+m)/2))?v=a:m=a,s=g,!(g=g[h=u<<1|l]))return s[h]=f,t;if(o=+t._x.call(null,g.data),c=+t._y.call(null,g.data),e===o&&n===c)return f.next=g,s?s[h]=f:t._root=f,t;do{s=s?s[h]=new Array(4):t._root=new Array(4),(l=e>=(r=(p+y)/2))?p=r:y=r,(u=n>=(a=(v+m)/2))?v=a:m=a}while((h=u<<1|l)==(d=(c>=a)<<1|o>=r));return s[d]=g,s[h]=f,t}function mt(t,e,n,i,s){this.node=t,this.x0=e,this.y0=n,this.x1=i,this.y1=s}function xt(t){return t[0]}function bt(t){return t[1]}function wt(t,e,n){var i=new _t(null==e?xt:e,null==n?bt:n,NaN,NaN,NaN,NaN);return null==t?i:i.addAll(t)}function _t(t,e,n,i,s,r){this._x=t,this._y=e,this._x0=n,this._y0=i,this._x1=s,this._y1=r,this._root=void 0}function Ct(t){for(var e={data:t.data},n=e;t=t.next;)n=n.next={data:t.data};return e}var kt=wt.prototype=_t.prototype;function St(){var t,e,n,i,s,r,a,o=0,c=vt(-30),l=1,u=1/0,h=.81;function d(){return 1e-6*(Math.random()-.5)}function g(t){return t.x}function f(t){return t.y}function p(s){var a,c=t.length;for(i&&!r(o,t)||(i=wt(t,g,f).visitAfter(y),t.update.push(o)),n=s,a=0;a<c;++a)e=t[a],i.visit(m);++o}function v(){if(t){o=0,t.update=[],r=s(),i=null;var e,n,l=t.length;for(a=new Array(l),e=0;e<l;++e)n=t[e],a[n.index]=+c(n,e,t)}}function y(t){var e,n,i,s,r,o=0,c=0;if(t.length){for(i=s=r=0;r<4;++r)(e=t[r])&&(n=Math.abs(e.value))&&(o+=e.value,c+=n,i+=n*e.x,s+=n*e.y);t.x=i/c,t.y=s/c}else{(e=t).x=e.data.x,e.y=e.data.y;do{o+=a[e.data.index]}while(e=e.next)}t.value=o}function m(t,i,s,r){if(!t.value)return!0;var o=t.x-e.x,c=t.y-e.y,g=r-i,f=o*o+c*c;if(g*g/h<f)return f<u&&(0===o&&(f+=(o=d())*o),0===c&&(f+=(c=d())*c),f<l&&(f=Math.sqrt(l*f)),e.vx+=o*t.value*n/f,e.vy+=c*t.value*n/f),!0;if(!(t.length||f>=u)){(t.data!==e||t.next)&&(0===o&&(f+=(o=d())*o),0===c&&(f+=(c=d())*c),f<l&&(f=Math.sqrt(l*f)));do{t.data!==e&&(f=(o=t.data.x-e.x)*o+(c=t.data.y-e.y)*c,0===o&&(f+=(o=d())*o),0===c&&(f+=(c=d())*c),f<l&&(f=Math.sqrt(l*f)),g=a[t.data.index]*n/f,e.vx+=o*g,e.vy+=c*g)}while(t=t.next)}}return s=function(){return function(t){return t%13==0}},p.initialize=function(e){t=e,v()},p.strength=function(t){return arguments.length?(c="function"==typeof t?t:vt(+t),v(),p):c},p.distanceMin=function(t){return arguments.length?(l=t*t,p):Math.sqrt(l)},p.distanceMax=function(t){return arguments.length?(u=t*t,p):Math.sqrt(u)},p.theta=function(t){return arguments.length?(h=t*t,p):Math.sqrt(h)},p.update=function(t){return arguments.length?(r=(s=t)(),p):s},p}function At(){var t=this;this.containers.canvas.context.clearRect(0,0,this.settings.width,this.settings.height),this.containers.canvas.context.save(),this.data.nested.sort((function(t,e){return t.value.stateChanges-e.value.stateChanges})).forEach((function(e,n){t.containers.canvas.context.beginPath(),t.containers.canvas.context.moveTo(e.x+e.r,e.y),t.containers.canvas.context.arc(e.x,e.y,e.value.r,0,2*Math.PI),t.settings.fill&&(t.containers.canvas.context.fillStyle=e.value.fill,t.containers.canvas.context.fill()),t.containers.canvas.context.strokeStyle=e.value.stroke,t.containers.canvas.context.stroke()})),this.containers.canvas.context.restore()}function Rt(t,e,n){var i=d3.forceSimulation().nodes(t).alphaDecay(.01).velocityDecay(.9).force("center",d3.forceCenter(this.settings.orbitRadius/2,this.settings.height/2)).force("x",d3.forceX(e).strength(.3)).force("y",d3.forceY(n).strength(.3)).force("charge",St().strength(this.settings.chargeStrength)).on("tick",At.bind(this));return i.force("collide",d3.forceCollide().radius(this.settings.minRadius+1)),i}function Bt(t,e,n){for(var i=d3.forceSimulation(t).force("charge",d3.forceCollide().radius(this.settings.minRadius+.5)).force("r",d3.forceRadial(this.settings.orbitRadius/2)).stop(),s=0;s<30;s++)i.tick();var r=this.containers.svgBackground.insert("g",":first-child").attr("transform","translate(".concat(e,",").concat(n,")")),a=r.selectAll("circle").data(t).enter().append("circle").attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y})).attr("r",this.settings.minRadius).attr("fill",this.settings.color(0)).attr("fill-opacity",.25);return{simulation:i,g:r,nodes:a}}function Mt(t,e,n,i){for(var s=d3.forceSimulation().nodes(t).force("center",d3.forceCenter(e,n)).force("x",d3.forceX(e).strength(.3)).force("y",d3.forceY(n).strength(.3)).force("charge",St().strength(this.settings.chargeStrength)).force("collide",d3.forceCollide().radius(this.settings.minRadius+.5)).stop(),r=0;r<300;r++)s.tick();var a=this.containers.svgBackground.insert("g",":first-child"),o=a.selectAll("circle").data(t).enter().append("circle").attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y})).attr("r",this.settings.minRadius).attr("fill",i).attr("fill-opacity",.25);return{simulation:s,g:a,nodes:o}}function Pt(){var t=this;if(this.settings.drawStaticSeparately){var e=this.data.nested.filter((function(t){return t.value.noStateChange})).map((function(t){return{key:t.key,category:t.value.category}}));return"categorical"===this.settings.colorBy.type?this.metadata.event[0].foci.map((function(n){var i=e.filter((function(t){return t.category===n.key}));return"radial"===t.settings.staticLayout?Bt.call(t,i,n.x,n.y,t.colorScale(n.key)):Mt.call(t,i,n.x,n.y,t.colorScale(n.key))})):"radial"===this.settings.staticLayout?[Bt.call(this,e,this.settings.orbitRadius/2,this.settings.height/2,this.settings.color(0))]:[Mt.call(this,e,this.settings.orbitRadius/2,this.settings.height/2,this.settings.color(0))]}}function jt(){var t=this;I.call(this),this.staticForceSimulation=Pt.call(this),this.metadata.event.forEach((function(e){if(void 0===e.foci){var n=Rt.call(t,e.data.filter((function(t){return!t.value.noStateChange})),e.x,e.y);n.category=null,n.coordinates=[e.x,e.y],e.forceSimulation=[n]}else e.forceSimulation=e.foci.map((function(n){var i=Rt.call(t,e.data.filter((function(t){return!t.value.noStateChange&&t.value.category===n.key})),n.x,n.y);return i.category=n.key,i.coordinates=[n.x,n.y],i}))})),"play"===this.settings.playPause&&(this.interval=$.call(this))}return kt.copy=function(){var t,e,n=new _t(this._x,this._y,this._x0,this._y0,this._x1,this._y1),i=this._root;if(!i)return n;if(!i.length)return n._root=Ct(i),n;for(t=[{source:i,target:n._root=new Array(4)}];i=t.pop();)for(var s=0;s<4;++s)(e=i.source[s])&&(e.length?t.push({source:e,target:i.target[s]=new Array(4)}):i.target[s]=Ct(e));return n},kt.add=function(t){var e=+this._x.call(null,t),n=+this._y.call(null,t);return yt(this.cover(e,n),e,n,t)},kt.addAll=function(t){var e,n,i,s,r=t.length,a=new Array(r),o=new Array(r),c=1/0,l=1/0,u=-1/0,h=-1/0;for(n=0;n<r;++n)isNaN(i=+this._x.call(null,e=t[n]))||isNaN(s=+this._y.call(null,e))||(a[n]=i,o[n]=s,i<c&&(c=i),i>u&&(u=i),s<l&&(l=s),s>h&&(h=s));if(c>u||l>h)return this;for(this.cover(c,l).cover(u,h),n=0;n<r;++n)yt(this,a[n],o[n],t[n]);return this},kt.cover=function(t,e){if(isNaN(t=+t)||isNaN(e=+e))return this;var n=this._x0,i=this._y0,s=this._x1,r=this._y1;if(isNaN(n))s=(n=Math.floor(t))+1,r=(i=Math.floor(e))+1;else{for(var a,o,c=s-n,l=this._root;n>t||t>=s||i>e||e>=r;)switch(o=(e<i)<<1|t<n,(a=new Array(4))[o]=l,l=a,c*=2,o){case 0:s=n+c,r=i+c;break;case 1:n=s-c,r=i+c;break;case 2:s=n+c,i=r-c;break;case 3:n=s-c,i=r-c}this._root&&this._root.length&&(this._root=l)}return this._x0=n,this._y0=i,this._x1=s,this._y1=r,this},kt.data=function(){var t=[];return this.visit((function(e){if(!e.length)do{t.push(e.data)}while(e=e.next)})),t},kt.extent=function(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},kt.find=function(t,e,n){var i,s,r,a,o,c,l,u=this._x0,h=this._y0,d=this._x1,g=this._y1,f=[],p=this._root;for(p&&f.push(new mt(p,u,h,d,g)),null==n?n=1/0:(u=t-n,h=e-n,d=t+n,g=e+n,n*=n);c=f.pop();)if(!(!(p=c.node)||(s=c.x0)>d||(r=c.y0)>g||(a=c.x1)<u||(o=c.y1)<h))if(p.length){var v=(s+a)/2,y=(r+o)/2;f.push(new mt(p[3],v,y,a,o),new mt(p[2],s,y,v,o),new mt(p[1],v,r,a,y),new mt(p[0],s,r,v,y)),(l=(e>=y)<<1|t>=v)&&(c=f[f.length-1],f[f.length-1]=f[f.length-1-l],f[f.length-1-l]=c)}else{var m=t-+this._x.call(null,p.data),x=e-+this._y.call(null,p.data),b=m*m+x*x;if(b<n){var w=Math.sqrt(n=b);u=t-w,h=e-w,d=t+w,g=e+w,i=p.data}}return i},kt.remove=function(t){if(isNaN(r=+this._x.call(null,t))||isNaN(a=+this._y.call(null,t)))return this;var e,n,i,s,r,a,o,c,l,u,h,d,g=this._root,f=this._x0,p=this._y0,v=this._x1,y=this._y1;if(!g)return this;if(g.length)for(;;){if((l=r>=(o=(f+v)/2))?f=o:v=o,(u=a>=(c=(p+y)/2))?p=c:y=c,e=g,!(g=g[h=u<<1|l]))return this;if(!g.length)break;(e[h+1&3]||e[h+2&3]||e[h+3&3])&&(n=e,d=h)}for(;g.data!==t;)if(i=g,!(g=g.next))return this;return(s=g.next)&&delete g.next,i?(s?i.next=s:delete i.next,this):e?(s?e[h]=s:delete e[h],(g=e[0]||e[1]||e[2]||e[3])&&g===(e[3]||e[2]||e[1]||e[0])&&!g.length&&(n?n[d]=g:this._root=g),this):(this._root=s,this)},kt.removeAll=function(t){for(var e=0,n=t.length;e<n;++e)this.remove(t[e]);return this},kt.root=function(){return this._root},kt.size=function(){var t=0;return this.visit((function(e){if(!e.length)do{++t}while(e=e.next)})),t},kt.visit=function(t){var e,n,i,s,r,a,o=[],c=this._root;for(c&&o.push(new mt(c,this._x0,this._y0,this._x1,this._y1));e=o.pop();)if(!t(c=e.node,i=e.x0,s=e.y0,r=e.x1,a=e.y1)&&c.length){var l=(i+r)/2,u=(s+a)/2;(n=c[3])&&o.push(new mt(n,l,u,r,a)),(n=c[2])&&o.push(new mt(n,i,u,l,a)),(n=c[1])&&o.push(new mt(n,l,s,r,u)),(n=c[0])&&o.push(new mt(n,i,s,l,u))}return this},kt.visitAfter=function(t){var e,n=[],i=[];for(this._root&&n.push(new mt(this._root,this._x0,this._y0,this._x1,this._y1));e=n.pop();){var s=e.node;if(s.length){var r,a=e.x0,o=e.y0,c=e.x1,l=e.y1,u=(a+c)/2,h=(o+l)/2;(r=s[0])&&n.push(new mt(r,a,o,u,h)),(r=s[1])&&n.push(new mt(r,u,o,c,h)),(r=s[2])&&n.push(new mt(r,a,h,u,l)),(r=s[3])&&n.push(new mt(r,u,h,c,l))}i.push(e)}for(;e=i.pop();)t(e.node,e.x0,e.y0,e.x1,e.y1);return this},kt.x=function(t){return arguments.length?(this._x=t,this):this._x},kt.y=function(t){return arguments.length?(this._y=t,this):this._y},function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={data:e,element:n,settings:Object.assign(i,s),util:t};return i.update.call(r),r.containers=x.call(r),r.metadata=C.call(r),ct.call(r),pt.call(r),jt.call(r),r}}));
